# Пошаговый процесс приема велосипеда

## Описание
Реализован улучшенный пошаговый процесс приема электровелосипеда при возврате с логичной последовательностью действий.

## Как это работает

### Шаг 1: Статус велосипеда
Администратор выбирает, куда отправить велосипед после возврата:
- **В свободные** - велосипед в хорошем состоянии, готов к следующей аренде
- **В ремонт** - требуется обслуживание или ремонт
  - При выборе "В ремонт" появляется поле для указания причины ремонта

### Шаг 2: Выявленные недостатки
Администратор указывает все обнаруженные недостатки:
- Каждый недостаток с новой строки
- Эти данные автоматически добавляются в акт приема-передачи
- Примеры: "Царапина на раме (левая сторона)", "Сломан звонок", "Потертость на седле"

### Шаг 3: Счет за ущерб
Администратор решает, нужно ли выставить счет:
- **Нет** - завершить приемку без выставления счета
- **Да, выставить счет** - списать сумму за повреждения
  - Указывается сумма к списанию (₽)
  - Указывается описание (например: "Ремонт поврежденной рамы")

## Процесс завершения

После нажатия кнопки "Завершить приемку":

1. **Если выбрано списание** - система автоматически:
   - Пытается списать с баланса клиента
   - Если баланса недостаточно - списывает с привязанной карты
   - Сохраняет информацию о недостатках в базе данных

2. **Генерация акта** - система:
   - Создает PDF акт приема-передачи с указанными недостатками
   - Загружает его в хранилище

3. **Обновление статусов**:
   - Велосипед получает выбранный статус (свободен/в ремонте)
   - Аренда переходит в статус "Ожидает подписи акта"
   - Клиенту отправляется уведомление в Telegram

4. **Уведомление клиента**:
   - Клиент получает сообщение о завершении аренды
   - Ему предлагается подписать акт сдачи в личном кабинете

## Технические детали

### Файлы
- `site/admin.html` - HTML разметка модального окна с шагами
- `site/admin.js` - JavaScript логика пошагового процесса
- `site/admin.css` - Стили для индикаторов шагов и карточек выбора
- `api/admin.js` - Серверная логика (charge-for-damages, finalize-return)

### API endpoints
- `POST /api/admin` с `action: 'charge-for-damages'` - списание средств за ущерб
- `POST /api/admin` с `action: 'finalize-return'` - завершение приемки
- `POST https://PRIZMATICdogovor.onrender.com/api/user` с `action: 'generate-return-act'` - генерация PDF акта

### Визуальные элементы
- Индикатор прогресса с 3 шагами
- Карточки выбора с радио-кнопками
- Плавные анимации переходов между шагами
- Адаптивная валидация на каждом шаге

## Преимущества новой реализации

1. **Логичная последовательность** - каждый шаг следует естественному порядку действий
2. **Меньше ошибок** - валидация на каждом шаге предотвращает пропуск важных данных
3. **Удобство** - визуальный индикатор показывает прогресс
4. **Гибкость** - можно вернуться на предыдущий шаг для исправления
5. **Автоматизация** - все действия выполняются последовательно без дополнительных кликов

## Использование

1. В таблице "Назначения" найдите аренду со статусом "Ожидает сдачи"
2. Нажмите кнопку "Принять велосипед"
3. Пройдите все 3 шага, заполняя необходимую информацию
4. Нажмите "Завершить приемку"
5. Система автоматически выполнит все необходимые действия

## Примечания

- Если выбран статус "В ремонт", обязательно указать причину
- Если выбрано списание средств, обязательно указать сумму и описание
- Недостатки можно не указывать, если их нет
- Можно вернуться на предыдущий шаг для изменения данных
