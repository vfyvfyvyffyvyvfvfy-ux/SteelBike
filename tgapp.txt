
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike App</title>
    <link rel="stylesheet" href="style.css?v=7.4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://briulxpnjxlsgfgkqvfh.supabase.co" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <script src="transitions.js" defer></script>

</head>
<body>
<script>
    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp
    async function initializeTelegramAuth() {
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É Telegram WebApp API
        let attempts = 0;
        const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

        while (attempts < maxAttempts) {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                console.log('Telegram WebApp detected!');
                break;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        const isInTelegram = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData;
        const userId = localStorage.getItem('userId');


        // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –∑–∞—Ä–∞–Ω–µ–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
        const appScreen = document.querySelector('.app-screen');
        if (appScreen) appScreen.style.display = 'none';

        if (isInTelegram && !userId) {
            // Show loading screen with background to cover everything
            const loadingHTML = `
                <div class="app-screen loading-container" style="display: flex; text-align: center; justify-content: center; align-items: center; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; background: white; z-index: 1000;">
                    <div class="app-content" style="justify-content: center;">
                        <header class="app-header"><h1>PRIZMATIC</h1></header>
                        <main class="app-main">
                            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</h2>
                            <p style="color: var(--text-secondary); margin: 20px 0;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ Telegram.</p>
                            <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto;"></div>
                        </main>
                    </div>
                </div>
                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>`;
            document.body.insertAdjacentHTML('afterbegin', loadingHTML);

            try {
                const tg = window.Telegram.WebApp;

                // –í–∞–∂–Ω–æ: —Ä–∞—Å—à–∏—Ä—è–µ–º WebApp –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                tg.expand();

                const initData = tg.initData;
                console.log('Sending initData to server:', initData ? 'Data present' : 'No data');

                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        initData: initData || '',
                        platform: tg.platform || 'unknown'
                    })
                });

                console.log('Fetch status:', response.status, response.ok);
                const data = await response.json();
                console.log('Server response:', data);

                if (response.ok && data.success) {
                    // Login successful
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('userName', data.user.name);
                    localStorage.setItem('isRegistered', 'true');
                    // Reload to load the app
                    window.location.reload();
                } else {
                    // Login failed, show styled message and redirect to bot for registration
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'app-screen';
                    messageDiv.style.display = 'flex';
                    messageDiv.style.position = 'fixed';
                    messageDiv.style.top = '0';
                    messageDiv.style.left = '0';
                    messageDiv.style.width = '100vw';
                    messageDiv.style.height = '100vh';
                    messageDiv.style.zIndex = '10000';
                    messageDiv.innerHTML = `
                        <div class="app-content" style="justify-content: center;">
                            <header class="app-header"><h1>Bike App</h1></header>
                            <main class="app-main" style="text-align: center;">
                                <h2>–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</h2>
                                <p style="color: var(--text-secondary); margin: 20px 0;">–ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –±—ã—Å—Ç—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤–∞–º –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.</p>
                                <button class="btn btn-primary" id="redirect-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                            </main>
                        </div>
                    `;
                    document.body.appendChild(messageDiv);

                    // Auto redirect after 5 seconds or on button click
                    const redirect = () => {
                        messageDiv.remove();
                        const botUsername = 'pr1zmaticbot';
                        const registrationLink = `https://t.me/${botUsername}?start=register`;
                        tg.openTelegramLink(registrationLink);
                    };

                    document.getElementById('redirect-btn').addEventListener('click', redirect);
                    setTimeout(redirect, 5000);
                }
            } catch (error) {
                console.error('Login error:', error);
                // Show error and registration option
                document.querySelector('.loading-container').innerHTML = `
                    <div class="app-content" style="justify-content: center;">
                        <header class="app-header"><h1>Bike App</h1></header>
                        <main class="app-main">
                            <h2>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
                            <p style="color: var(--text-secondary); margin: 20px 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
                            <p id="countdown" style="color: var(--text-secondary); margin: 10px 0;">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>
                            <button id="redirect-to-bot-btn" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                        </main>
                    </div>`;

                    // Add countdown for error screen too
                    let countdown = 5;
                    const countdownEl = document.getElementById('countdown');
                    const interval = setInterval(() => {
                        countdown--;
                        if (countdownEl) countdownEl.textContent = `–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${countdown} —Å–µ–∫—É–Ω–¥...`;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            const tg = window.Telegram.WebApp;
                            tg.sendData(JSON.stringify({ type: 'request_registration' }));
                            tg.close();
                        }
                    }, 1000);

                    // Button click
                    const btn = document.getElementById('redirect-to-bot-btn');
                    btn.addEventListener('click', () => {
                        clearInterval(interval);
                        const tg = window.Telegram.WebApp;
                        tg.sendData(JSON.stringify({ type: 'request_registration' }));
                        tg.close();
                    });
            }
        } else {
            // For browser or already logged in users
            console.log('Not in Telegram or already logged in');
            const appScreen = document.querySelector('.app-screen');
            if (appScreen) appScreen.style.display = 'flex';
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeTelegramAuth);
    } else {
        // DOMContentLoaded —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–µ–ª
        initializeTelegramAuth();
    }
</script>

<div class="app-screen">
    <div class="app-content">
        <header class="app-header">
            <h1></h1>
        </header>
        <main class="app-main">
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Electric bike" class="bike-image" id="main-bike-image" width="1536" height="1024" decoding="async" fetchpriority="high">
                <div id="bike-label" class="bike-label"></div>
            </div>
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar-fill"></div>
                </div>
                <div class="progress-labels">
                    <span id="progress-start-label"></span>
                    <span id="progress-end-label"></span>
                </div>
            </div>
            <h2></h2>
            <div class="info-cards">
                <div class="card">
                    <div class="icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <div class="text-content">
                        <span></span>
                        <strong id="available-bikes-count"></strong>
                    </div>
                </div>
                <div class="card" id="balance-card">
                    <div class="icon-wrapper dollar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="text-content">
                        <span></span>
                        <strong id="balance-amount"></strong>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="scan-qr-btn"></button>
                <div class="secondary-actions">
                    <button class="btn btn-secondary" id="scan-icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg></button>
                    <button class="btn btn-secondary text-btn" id="id-input-btn"></button>
                    <button class="btn btn-secondary text-btn" id="extend-row-btn"></button>
                    <button class="btn btn-secondary text-btn" id="booking-btn"></button>
                </div>
            </div>
            <div id="extend-container" class="hidden extend-container">
                <button id="extend-rental-btn" class="btn btn-primary"></button>
            </div>
        </main>
    </div>
        <nav class="bottom-nav">
        <a href="index.html" class="nav-item active"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a>
        <a href="stats.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></a>
        <a href="map.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></a>
        <a href="profile.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></a>
    </nav>
</div>
<div id="qr-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="qr-modal-close-btn">&times;</button>
        <h2>–í—ã –∞—Ä–µ–Ω–¥—É–µ—Ç–µ<br>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00001</h2>
        <div class="bike-specs">
            <div class="spec-item"><span class="spec-label">–ú–∞–∫—Å–∏–º–∞–ª–∫–∞:</span><span class="spec-value">25 –∫–º/—á</span></div>
            <div class="spec-item"><span class="spec-label">–ü—Ä–æ–±–µ–≥:</span><span class="spec-value">–¥–æ 40 –∫–º</span></div>
            <div class="spec-item"><span class="spec-label">–ú–æ—â–Ω–æ—Å—Ç—å:</span><span class="spec-value">240 –í—Ç</span></div>
            <div class="spec-item"><span class="spec-label">–ë–∞—Ç–∞—Ä–µ—è:</span><span class="spec-value">60–í/20Ah</span></div>
            <div class="spec-item"><span class="spec-label">–ó–∞—Ä—è–¥–∫–∞:</span><span class="spec-value">6 —á</span></div>
            <div class="spec-item"><span class="spec-label">–ü—Ä–∏–≤–æ–¥:</span><span class="spec-value">–∑–∞–¥–Ω–∏–π</span></div>
            <div class="spec-item"><span class="spec-label">–¢–æ—Ä–º–æ–∑–∞:</span><span class="spec-value">–≥–∏–¥—Ä–∞–≤–ª–∏–∫–∞</span></div>
        </div>
        <div class="modal-info">
            <span>–¶–µ–Ω–∞: <strong id="tariff-price">3750 ‚ÇΩ</strong></span>
            <span>–°—Ä–æ–∫: <strong id="tariff-duration">7 –¥–Ω–µ–π</strong></span>
        </div>
        <p id="tariff-description" style="margin: 10px 0; font-size: 0.9rem; color: var(--text-secondary);"></p>
        <p class="disclaimer-text">–û–ø–ª–∞—á–∏–≤–∞—è, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏.</p>
        <button class="btn btn-primary" id="rent-btn" data-action="rent">–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å</button>
    </div>
</div>
<div id="topup-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="topup-modal-close-btn">&times;</button>
        <h2>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
        <div class="modal-form-group">
            <label for="amount-input" style="text-align: center;">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
            <input type="number" id="amount-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ ‚ÇΩ">
        </div>
        <button class="btn btn-primary" id="pay-sbp-btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </div>
</div>
<div id="id-input-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="id-input-modal-close-btn">&times;</button>
        <h2>–í–≤–µ—Å—Ç–∏ ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞</h2>
        <div class="modal-form-group">
            <label for="bike-id-input">ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞</label>
            <input type="text" id="bike-id-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 00001">
        </div>
        <button class="btn btn-primary" id="confirm-id-btn">–ù–∞–π—Ç–∏ –∏ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å</button>
    </div>—Ñ
</div>
<div id="booking-list-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="booking-list-modal-close-btn">&times;</button>
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –¥–ª—è –±—Ä–æ–Ω–∏</h2>
        <div class="bike-list">
            <div class="bike-list-item" data-bike-id="00001"><strong>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00001</strong><span>300 –º</span></div>
            <div class="bike-list-item" data-bike-id="00002"><strong>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00002</strong><span>850 –º</span></div>
            <div class="bike-list-item" data-bike-id="00003"><strong>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00003</strong><span>1.1 –∫–º</span></div>
            <div class="bike-list-item" data-bike-id="00004"><strong>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00004</strong><span>2.4 –∫–º</span></div>
            <div class="bike-list-item" data-bike-id="00005"><strong>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #00005</strong><span>4.0 –∫–º</span></div>
        </div>
    </div>
</div>
<div id="tariff-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="tariff-modal-close-btn">&times;</button>
        <h2>–¢–∞—Ä–∏—Ñ—ã</h2>
        <div class="bike-list">
            <div class="bike-list-item tariff-option" data-tariff="bronze"><strong>–ë—Ä–æ–Ω–∑–∞</strong><span>1000 ‚ÇΩ / 3 –¥–Ω—è</span></div>
            <div class="bike-list-item tariff-option" data-tariff="silver"><strong>–°–µ—Ä–µ–±—Ä–æ</strong><span>2000 ‚ÇΩ / 5 –¥–Ω–µ–π</span></div>
            <div class="bike-list-item tariff-option" data-tariff="gold"><strong>–ó–æ–ª–æ—Ç–æ</strong><span>3750 ‚ÇΩ / 7 –¥–Ω–µ–π</span></div>
        </div>
        <p class="disclaimer-text">–û–ø–ª–∞—á–∏–≤–∞—è, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏.</p>
    </div>
</div>
<div id="tariff-detail-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="tariff-detail-close-btn">&times;</button>
        <h2 id="tariff-detail-title"></h2>
        <p id="tariff-detail-description" class="tariff-description"></p>

        <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
        <div class="tariff-options-list" id="tariff-options-list">
            <!-- –°—é–¥–∞ JavaScript –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã -->
        </div>

        <button class="btn btn-primary" id="select-tariff-btn">–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</button>
    </div>
</div>
<div id="extend-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" id="extend-close-btn">&times;</button>
        <h2>–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É</h2>
        <ul id="extend-options" class="extend-options-list"></ul>
        <div class="modal-actions" style="display:flex;gap:10px;margin-top:20px;">
            <button type="button" id="extend-cancel-btn" class="btn btn-secondary" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" id="extend-select-btn" class="btn btn-primary" style="flex:1;">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
        </div>
    </div>
</div>
<div id="notification-toast" class="toast-container hidden"><p class="toast-message">–ù–∞ –≤–∞—à–µ–º —Å—á–µ—Ç—É –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.</p></div>
<div id="success-toast" class="toast-container toast-success hidden"><p class="toast-message">–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ <strong id="success-amount"></strong>!</p></div>
<div id="rent-success-toast" class="toast-container toast-success hidden"><p class="toast-message">–ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞! –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.</p></div>
<div id="booking-success-toast" class="toast-container toast-success hidden"><p class="toast-message">–í–µ–ª–æ—Å–∏–ø–µ–¥ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ 1 —á–∞—Å!</p></div>
        

        <div id="main-menu-overlay" class="menu-overlay hidden" role="dialog" aria-modal="true" style="display:none;">
            <div class="menu-container">
            </div>
        </div>

    <script>
    const SUPABASE_URL = 'https://briulxpnjxlsgfgkqvfh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyaXVseHBuanhsc2dmZ2txdmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzUwNzEsImV4cCI6MjA3NDc1MTA3MX0.Zj-V22HQ2MlZJToC4ZzBcfqPtAVI8NAjb7TQMiJQU60';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const CURRENCY_SYMBOL = '‚ÇΩ';
    let userBalance = 0;
    let currentRentalForExtension = null;
    const formatBalance = (value) => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) {
            return `... ${CURRENCY_SYMBOL}`;
        }
        return `${Math.round(numeric)} ${CURRENCY_SYMBOL}`;
    };
    const updateBalanceDisplays = (value) => {
        if (typeof value === 'number' && !Number.isNaN(value)) {
            userBalance = value;
        }
        const textValue = formatBalance(userBalance);
        document.querySelectorAll('#balance-amount, .balance-amount').forEach((el) => {
            el.textContent = textValue;
        });
    };

    function toggleButtonLoading(btn, isLoading, textIdle, textBusy) {
        if (!btn) return;
        btn.disabled = !!isLoading;
        btn.textContent = isLoading ? textBusy : textIdle;
    }


async function initializeRentalSystem() {
    const mainContent = document.querySelector('.app-main');
    const appHeader = document.querySelector('.app-header h1');
    let currentUser = null;
    let activeRental = null;
    const renderDefaultView = () => {
        mainContent.innerHTML = `
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Electric bike" class="bike-image" id="main-bike-image">
            </div>
            <div class="progress-section">
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar-fill"></div></div>
                <div class="progress-labels"><span id="progress-start-label">0 –¥–Ω–µ–π</span><span id="progress-end-label">...</span></div>
            </div>
            <h2>–ù–∞–π—Ç–∏ –∏ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ —Ä—è–¥–æ–º.</h2>
            <div class="info-cards">
                <div class="card"><div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div><div class="text-content"><span>–°–≤–æ–±–æ–¥–Ω—ã—Ö</span><strong id="available-bikes-count">100</strong></div></div>
                <div class="card" id="balance-card"><div class="icon-wrapper dollar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></div><div class="text-content"><span>–ë–∞–ª–∞–Ω—Å</span><strong id="balance-amount">0 ‚ÇΩ</strong></div></div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="scan-qr-btn">–¢–∞—Ä–∏—Ñ—ã</button>
                <div class="secondary-actions">
                    <button class="btn btn-secondary text-btn" id="id-input-btn">–í–≤–µ—Å—Ç–∏ ID</button>
                    <button class="btn btn-secondary text-btn" id="booking-btn">–ë—Ä–æ–Ω—å</button>
                    <button class="btn btn-secondary text-btn" id="extend-row-btn">–ü—Ä–æ–¥–ª–µ–Ω–∏–µ</button>
                </div>
            </div>
            <div id="extend-container" class="hidden extend-container"><button id="extend-rental-btn" class="btn btn-primary">–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É</button></div>
        `;
        initializeMainScreenEventListeners(startRentalFlow);
    };
    const renderActiveRentalView = (rental) => {
        const endsDate = new Date(rental.current_period_ends_at);
        const daysLeft = Math.ceil((endsDate - new Date()) / (1000 * 60 * 60 * 24));
        const durationDays = rental.tariffs?.duration_days || 7;
        const progress = Math.max(0, 100 - (daysLeft / durationDays * 100));

        mainContent.innerHTML = `
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Rented Electric bike" class="bike-image" width="1536" height="1024" decoding="async" fetchpriority="high">
            </div>
            <div class="progress-section">
                <div class="progress-bar-container"><div class="progress-bar" style="width: ${progress}%;"></div></div>
                <div class="progress-labels"><span>–í –∞—Ä–µ–Ω–¥–µ</span><span>–û—Å—Ç–∞–ª–æ—Å—å ~${daysLeft} –¥.</span></div>
            </div>
            <h2>–í–∞—à–∞ –∞—Ä–µ–Ω–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞</h2>
            <p style="text-align: center; color: var(--dark-green);">–°–ª–µ–¥—É—é—â–µ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ ${endsDate.toLocaleDateString('ru-RU')}.</p>
            <div class="action-buttons">
                <button class="btn btn-primary" id="return-bike-btn">–°–¥–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥</button>
            </div>`;
        document.getElementById('return-bike-btn').addEventListener('click', returnBike);
    };

    const renderOverdueRentalView = (rental) => {
        mainContent.innerHTML = `
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Rented Electric bike" class="bike-image" width="1536" height="1024" decoding="async" fetchpriority="high" style="filter: grayscale(1);">
            </div>
            <h2 style="color: #e53e3e; text-align: center;">–ê—Ä–µ–Ω–¥–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</h2>
            <p style="text-align: center; color: var(--dark-green);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã.</p>
            <div class="action-buttons">
                <button class="btn btn-primary" id="retry-payment-btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
                <button class="btn btn-secondary text-btn" id="return-bike-btn">–°–¥–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥</button>
            </div>`;
        document.getElementById('retry-payment-btn').addEventListener('click', retryPayment);
        document.getElementById('return-bike-btn').addEventListener('click', returnBike);
    };
    
    const renderPendingReturnView = (rental) => {
        mainContent.innerHTML = `
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Rented Electric bike" class="bike-image" width="1536" height="1024" decoding="async" fetchpriority="high" style="opacity: 0.7;">
            </div>
            <h2 style="text-align: center;">–û–∂–∏–¥–∞–Ω–∏–µ —Å–¥–∞—á–∏</h2>
            <p style="text-align: center; color: var(--dark-green);">–ó–∞—è–≤–∫–∞ –Ω–∞ —Å–¥–∞—á—É –ø—Ä–∏–Ω—è—Ç–∞. –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>`;
    };
    const startRentalFlow = async () => {
        const tariffId = 1;
        const bikeId = "00001";
        
        const button = document.getElementById('scan-qr-btn') || document.getElementById('rent-flow-start-btn');
        if (!button) return;
        button.disabled = true;
        button.textContent = '–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑...';

        try {
            const response = await fetch('/api/payments', {
                method: 'POST',
                body: JSON.stringify({ action: 'create-payment', userId: currentUser.id, bikeId, tariffId })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            if (data.confirmation_url) {
                window.location.href = data.confirmation_url;
            } else {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
            button.disabled = false;
            button.textContent = '–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥';
        }
    };
    const returnBike = async () => {
        if (!activeRental || !confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥?")) return;
        
        const { error } = await supabase
            .from('rentals')
            .update({ status: 'pending_return' })
            .eq('id', activeRental.id);
            
        if (error) {
            alert("–û—à–∏–±–∫–∞: " + error.message);
        } else {
            renderPendingReturnView(activeRental);
        }
    };
    const retryPayment = () => {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã.");
    };
    const initializePage = async () => {
        const userId = localStorage.getItem('userId');
        const { data: client, error: clientError } = await supabase.from('clients').select('*').eq('id', userId).single();
        if (clientError || !client) {
            console.error('Client load error:', clientError);
            return; // Exit if no client
        }
        currentUser = client;
        appHeader.textContent = `${currentUser.name ? currentUser.name.split(' ')[0] : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;

        // –í—ã–∑—ã–≤–∞–µ–º –í–ê–®–£ —Ñ—É–Ω–∫—Ü–∏—é `loadUserData`, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –µ–π –∫–æ–ª–±—ç–∫
        loadUserData(supabase, () => {
            // –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞
            checkAndRenderRentalStatus();
        });
    };
    const checkAndRenderRentalStatus = async () => {
        const { data: rental, error: rentalError } = await supabase
            .from('rentals')
            .select('*, tariffs(duration_days)')
            .eq('user_id', currentUser.id)
            .in('status', ['active', 'overdue', 'pending_return'])
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
        if (rentalError && rentalError.code !== 'PGRST116') {
             console.error("Rental fetch error:", rentalError);
        }
        activeRental = rental;
        if (activeRental) {
            switch(activeRental.status) {
                case 'active': renderActiveRentalView(activeRental); break;
                case 'overdue': renderOverdueRentalView(activeRental); break;
                case 'pending_return': renderPendingReturnView(activeRental); break;
                default: renderDefaultView();
            }
        } else {
            renderDefaultView();
        }
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë
    initializePage();
}
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
    function showBotRegistrationScreen() {
        document.querySelector('.app-screen').innerHTML = `
            <div class="app-content">
                <header class="app-header">
                    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
                </header>
                <main class="app-main" style="text-align: center; padding: 40px 20px;">
                    <h2>–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º</h2>
                    <p style="color: var(--text-secondary); margin: 20px 0;">–ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                    <button class="btn btn-primary" id="share-contact-btn" style="margin-top: 30px;">
                        üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
                    </button>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px;">
                        –ò–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start
                    </p>
                </main>
            </div>
        `;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
        document.getElementById('share-contact-btn').addEventListener('click', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç
                window.Telegram.WebApp.requestContact((success, contact) => {
                    if (success && contact) {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –±–æ—Ç—É
                        const data = {
                            action: 'start_registration',
                            phone: contact.phone_number,
                            first_name: contact.first_name,
                            last_name: contact.last_name
                        };
                        window.Telegram.WebApp.sendData(JSON.stringify(data));
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
                        window.Telegram.WebApp.close();
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    }
                });
            } else {
                alert('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeRentalSystem();
    });
    document.addEventListener('DOMContentLoaded', () => {
        const userName = localStorage.getItem('userName');
        if (userName) {
            document.querySelector('.app-header h1').textContent = '';
        }
        const appScreen = document.querySelector('.app-screen');
        const navLinks = document.querySelectorAll('.bottom-nav a.nav-item');
        const animationDuration = 400;

        appScreen.classList.add('page-enter');
        requestAnimationFrame(() => {
            appScreen.classList.remove('page-enter');
            appScreen.classList.add('page-enter-active');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.parentElement.classList.contains('active') || link.classList.contains('active')) {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                const destination = e.currentTarget.href;
                appScreen.classList.remove('page-enter-active');
                appScreen.classList.add('page-exit-active');
                setTimeout(() => {
                    window.location.href = destination;
                }, animationDuration);
            });
        });
        const balanceAmountElement = document.getElementById('balance-amount');
        const availableBikesCount = document.getElementById('available-bikes-count');
        const mainBikeImage = document.getElementById('main-bike-image');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressStartLabel = document.getElementById('progress-start-label');
        const progressEndLabel = document.getElementById('progress-end-label');
        const bikeLabelElement = document.getElementById('bike-label');
        function saveAppState() {
            const appState = {
                balance: balanceAmountElement.textContent,
                availableBikes: availableBikesCount.textContent,
                bikeImage: mainBikeImage.getAttribute('src'),
                progressWidth: progressBarFill.style.width,
                progressColor: progressBarFill.style.backgroundColor,
                progressStart: progressStartLabel.textContent,
                progressEnd: progressEndLabel.textContent
            };
            localStorage.setItem('appState', JSON.stringify(appState));
        }

       // –§–∞–π–ª: index.html, –≤–Ω—É—Ç—Ä–∏ <script>

       // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ò–ù–ì–ê –ò –î–ï–ô–°–¢–í–ò–ô ---
    const returnBike = async (rentalId) => {
        if (!rentalId || !confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥?")) return;
        
        const { error } = await supabase
            .from('rentals')
            .update({ status: 'pending_return' })
            .eq('id', rentalId);
            
        if (error) {
            alert("–û—à–∏–±–∫–∞: " + error.message);
        } else {
            window.location.reload();
        }
    };
    
    const retryPayment = () => {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã.");
    };


    const renderDefaultView = (container) => {
        document.querySelector('.app-header')?.classList.remove('header-centered');
        container.innerHTML = `
            <div class="bike-image-wrapper">
                <img src="bike-delivery.png" alt="Electric bike" class="bike-image" id="main-bike-image" width="1536" height="1024" decoding="async" fetchpriority="high">
            </div>
            <div class="progress-section">
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar-fill"></div></div>
                <div class="progress-labels"><span id="progress-start-label">0 –¥–Ω–µ–π</span><span id="progress-end-label">...</span></div>
            </div>
            <h2>–ù–∞–π—Ç–∏ –∏ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ —Ä—è–¥–æ–º.</h2>
            <div class="info-cards">
                <div class="card"><div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div><div class="text-content"><span>–°–≤–æ–±–æ–¥–Ω—ã—Ö</span><strong id="available-bikes-count">...</strong></div></div>
                <div class="card" id="balance-card"><div class="icon-wrapper dollar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></div><div class="text-content"><span>–ë–∞–ª–∞–Ω—Å</span><strong id="balance-amount">0 ‚ÇΩ</strong></div></div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="scan-qr-btn">–¢–∞—Ä–∏—Ñ—ã</button>
                <div class="secondary-actions"><button class="btn btn-secondary" id="scan-icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg></button><button class="btn btn-secondary text-btn" id="id-input-btn">–í–≤–µ—Å—Ç–∏ ID</button><button class="btn btn-secondary text-btn" id="booking-btn">–ë—Ä–æ–Ω—å</button></div>
            </div>
            <div id="extend-container" class="hidden extend-container"><button id="extend-rental-btn" class="btn btn-primary">–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É</button></div>
        `;
    };

    async function loadUserData() {
    const userId = localStorage.getItem('userId');
    const appHeader = document.querySelector('.app-header'); // –ù–∞—Ö–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫

    if (!userId) {
        // Removed redirection to registration.html
        return;
    }

    try {
        const { data: client, error } = await supabase
            .from('clients')
            .select('verification_status, name, balance_rub, city') // <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1
            .eq('id', userId)
            .single();

        if (error || !client) throw new Error(error ? error.message : "–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");

        const userName = client.name ? client.name.split(' ')[0] : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const mainContent = document.querySelector('.app-main');
        const status = client.verification_status;

        appHeader.classList.remove('header-centered');

        if (status === 'approved') {
            appHeader.classList.add('header-centered');
            appHeader.querySelector('h1').textContent = '';
            
            const { data: rental, error: rentalError } = await supabase
                .from('rentals')
                .select('*, tariffs(*)')
                .eq('user_id', userId)
                .in('status', ['active', 'overdue', 'pending_return'])
                .order('created_at', { ascending: false })
                .limit(1)
                .single();

            if (rentalError && rentalError.code !== 'PGRST116') {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã:", rentalError);
                mainContent.innerHTML = `<h2 style="text-align: center; color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –∞—Ä–µ–Ω–¥–µ.</h2>`;
                return;
            }

            if (rental) {
                switch(rental.status) {
                    case 'active':
                        renderActiveRentalView(rental, mainContent);
                        break;
                    case 'overdue':
                        renderOverdueRentalView(rental, mainContent);
                        break;
                    case 'pending_return':
                        renderPendingReturnView(rental, mainContent);
                        break;
                    default:
                        renderDefaultView(mainContent);
                        initializeMainScreenEventListeners();
                }
                loadAvailableBikesCount(client.city);
            } else {
                renderDefaultView(mainContent);
                loadAvailableBikesCount(client.city);
                initializeMainScreenEventListeners();
                (function(){
                    // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ renderDefaultView
                })();
                        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê ---
                        if (typeof client.balance_rub !== 'undefined') {
                            updateBalanceDisplays(Number(client.balance_rub));
                        } else {
                            updateBalanceDisplays();
                        }
                
                        // --- REAL-TIME BALANCE SUBSCRIPTION ---
                        supabase
                            .channel(`client-balance-${userId}`)
                            .on('postgres_changes', {
                                event: 'UPDATE',
                                schema: 'public',
                                table: 'clients',
                                filter: `id=eq.${userId}`
                            }, payload => {
                                if (payload.new && typeof payload.new.balance_rub !== 'undefined') {
                                    console.log('Real-time balance update:', payload.new.balance_rub);
                                    updateBalanceDisplays(payload.new.balance_rub);
                                }
                            })
                            .subscribe();            }
        } else {
            appHeader.classList.add('header-centered');
            appHeader.querySelector('h1').textContent = '';
            
            let headerText = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ';
            let statusTitle = '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ';
            let statusSubtitle = '–¥–æ 24 —á–∞—Å–æ–≤';

            if (status === 'rejected') {
                headerText = '–í –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–∫–∞–∑–∞–Ω–æ';
                statusTitle = '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
                statusSubtitle = '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π';
            }
            
            mainContent.innerHTML = `
                <div class="verification-container">
                    <h2 class="verification-header">${headerText}</h2>
                    <div class="verification-status-card">
                        <div class="verification-status-info">
                            <h3>${statusTitle}</h3>
                            ${status !== 'rejected' ? '<div class="progress-bar-container"><div class="progress-bar"></div></div>' : ''}
                            <p>${statusSubtitle}</p>
                        </div>
                    </div>
                    <h2>–ß–µ–º –∑–∞–Ω—è—Ç—å—Å—è –ø–æ–∫–∞ –∂–¥—ë—Ç–µ</h2>
                    <div class="actions-grid">
                        <div class="action-card" id="goto-profile-action">
                            <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                            <span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
                        </div>
                        <div class="action-card" id="connect-card-action">
                             <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
                            <span>–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Ä—Ç—É</span>
                        </div>
                         <div class="action-card" id="support-action">
                            <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
                            <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                        </div>
                         <div class="action-card" id="invite-friend-action">
                            <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></div>
                            <span>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</span>
                        </div>
                    </div>
                </div>
            `;
            initializeVerificationScreenEventListeners();
        }
        
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
        appHeader.classList.add('header-centered');
        appHeader.querySelector('h1').textContent = `–û—à–∏–±–∫–∞`;
        mainContent.innerHTML = `<h2 style="text-align: center; color: red; padding-top: 40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</h2>`;
    }
}

async function loadAvailableBikesCount(userCity) {
    if (!userCity) return;
    const { data: bikes, error } = await supabase
        .from('bikes')
        .select('id')
        .eq('city', userCity)
        .eq('status', 'available');
    if (!error && bikes) {
        const countEl = document.getElementById('available-bikes-count');
        if (countEl) countEl.textContent = bikes.length;
    }
}

// –§—É–Ω–∫—Ü–∏–∏ initializeVerificationScreenEventListeners –∏ initializeMainScreenEventListeners –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
function initializeVerificationScreenEventListeners() {
    document.getElementById('goto-profile-action')?.addEventListener('click', () => {
        window.location.href = 'profile.html';
    });
    
    document.getElementById('connect-card-action')?.addEventListener('click', () => {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–æ—Ñ–∏–ª—è —Å—Ä–∞–∑—É –Ω–∞ —Ä–∞–∑–¥–µ–ª–µ –∫–∞—Ä—Ç—ã
        window.location.href = 'profile.html#card'; // –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    });

    document.getElementById('support-action')?.addEventListener('click', () => {
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –º–æ–¥–∞–ª–∫–∞ —Å id="support-modal" –≤ DOM index.html –∏–ª–∏ –≤—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ
        alert('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É...');
    });

    document.getElementById('invite-friend-action')?.addEventListener('click', () => {
        const inviteLink = 'https://lucent-marshmallow-217b1e.netlify.app/registration.html?ref=12345';
        navigator.clipboard.writeText(inviteLink).then(() => {
            alert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.');
        });
    });
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ (–∫–æ–≥–¥–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞)
function initializeMainScreenEventListeners() {
    // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –í–ï–°–¨ –∫–æ–¥ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —É –≤–∞—Å –Ω–∞ index.html
    // –ù–∞–ø—Ä–∏–º–µ—Ä:
    document.getElementById('scan-qr-btn')?.addEventListener('click', () => { /* ... */ });
    document.getElementById('balance-card')?.addEventListener('click', () => { /* ... */ });
    // –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫...
}


        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        loadUserData();
        // –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –∞—Ä–µ–Ω–¥–∞
        if (typeof updateExtendButton === 'function') {
            updateExtendButton();
        }

        // –¢–ï–ü–ï–†–¨ –ù–ê–•–û–î–ò–ú –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´
        // (–æ–±—ä—è–≤–ª–µ–Ω–∏–µ bikeLabelElement –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤—ã—à–µ, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        const scanBtn = document.getElementById('scan-qr-btn');
        const scanIconBtn = document.getElementById('scan-icon-btn');
        const idInputBtn = document.getElementById('id-input-btn');
        const extendRowBtn = document.getElementById('extend-row-btn');
        const bookingBtn = document.getElementById('booking-btn');
        const rentBtn = document.getElementById('rent-btn');
        const qrModal = document.getElementById('qr-modal');
        const qrModalCloseBtn = document.getElementById('qr-modal-close-btn');
        const idInputModal = document.getElementById('id-input-modal');
        const idInputModalCloseBtn = document.getElementById('id-input-modal-close-btn');
        const bikeIdInput = document.getElementById('bike-id-input');
        const confirmIdBtn = document.getElementById('confirm-id-btn');
        const bookingListModal = document.getElementById('booking-list-modal');
        const bookingListModalCloseBtn = document.getElementById('booking-list-modal-close-btn');
        const bikeList = document.querySelector('.bike-list');
        const balanceCard = document.getElementById('balance-card');
        const topupModal = document.getElementById('topup-modal');
        const topupModalCloseBtn = document.getElementById('topup-modal-close-btn');
        const payBtn = document.getElementById('pay-sbp-btn');
        const amountInput = document.getElementById('amount-input');
        const notificationToast = document.getElementById('notification-toast');
        const successToast = document.getElementById('success-toast');
        const successAmountSpan = document.getElementById('success-amount');
        const rentSuccessToast = document.getElementById('rent-success-toast');
        const bookingSuccessToast = document.getElementById('booking-success-toast');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PRIZMATIC —Ç–∞—Ä–∏—Ñ–∞–º–∏
        const tariffModal = document.getElementById('tariff-modal');
        const tariffModalCloseBtn = document.getElementById('tariff-modal-close-btn');

        /**
         * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
         * –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (QR –∏–ª–∏ PRIZMATIC). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
         * –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR‚Äë–∫–æ–¥¬ª –∏ —Ç—Ä–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö
         * –¥–µ–π—Å—Ç–≤–∏—è. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ PRIZMATIC –æ—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
         * –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ ¬´–¢–∞—Ä–∏—Ñ—ã¬ª, –∞ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è
         * —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ
         * –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–≤–µ—Å—Ç–∏ ID.
         */
        function applyProviderUI() {
            const provider = localStorage.getItem('paymentProvider') || 'PRIZMATIC';
            if (provider === 'PRIZMATIC') {
                // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                scanBtn.textContent = '–¢–∞—Ä–∏—Ñ—ã';
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–Ω–æ–ø–∫—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                if (scanIconBtn) scanIconBtn.style.display = 'none';
                if (bookingBtn) bookingBtn.style.display = '';
            } else {
                // –í —Ä–µ–∂–∏–º–µ QR –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–¥–ø–∏—Å—å –∏ –≤—Å–µ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                scanBtn.textContent = '–¢–∞—Ä–∏—Ñ—ã';
                if (scanIconBtn) scanIconBtn.style.display = '';
                if (bookingBtn) bookingBtn.style.display = '';
            }
        }
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        applyProviderUI();
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        // —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ). –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö,
        // –ø–æ—ç—Ç–æ–º—É –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–∂–µ—Ç –Ω–µ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç.
        window.addEventListener('storage', (e) => {
            if (e.key === 'paymentProvider') {
                applyProviderUI();
            }
        });

        // –î—É–±–ª–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞ —Å–æ–±—ã—Ç–∏–µ storage, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
        window.addEventListener('storage', (e) => {
            if (e.key !== 'paymentProvider') return;
            (function(){
                const _scanBtn = document.getElementById('scan-qr-btn');
                const _scanIconBtn = document.getElementById('scan-icon-btn');
                const _bookingBtn = document.getElementById('booking-btn');
                const _provider = localStorage.getItem('paymentProvider') || 'qr';
                if (!_scanBtn) return;
                if (_provider === 'PRIZMATIC') {
                    _scanBtn.textContent = '–¢–∞—Ä–∏—Ñ—ã';
                    if (_scanIconBtn) _scanIconBtn.style.display = 'none';
                    if (_bookingBtn) _bookingBtn.style.display = '';
                } else {
                    _scanBtn.textContent = '–¢–∞—Ä–∏—Ñ—ã';
                    if (_scanIconBtn) _scanIconBtn.style.display = '';
                    if (_bookingBtn) _bookingBtn.style.display = '';
                }
            })();
        });

        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        const showToast = (toastElement, duration = 3000) => {
            toastElement.classList.remove('hidden');
            setTimeout(() => toastElement.classList.add('hidden'), duration);
        };
        const changeBikeImage = (newSrc) => {
            mainBikeImage.classList.add('fade-out');
            setTimeout(() => {
                mainBikeImage.src = newSrc; // <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–ë–ò–†–ê–ï–ú file:///android_asset/
                mainBikeImage.classList.remove('fade-out');
                saveAppState();
            }, 300);
        };
        const addTransactionToHistory = (transaction) => {
            const history = JSON.parse(localStorage.getItem('bikeHistory')) || [];
            transaction.date = new Date().toISOString();
            history.push(transaction);
            localStorage.setItem('bikeHistory', JSON.stringify(history));
        };

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
         * –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ PRIZMATIC, –º—ã –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (–ë—Ä–æ–Ω–∑–∞,
         * –°–µ—Ä–µ–±—Ä–æ –∏–ª–∏ –ó–æ–ª–æ—Ç–æ). –í –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞—è—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–æ–º–µ—Ä
         * –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä ¬´00001¬ª. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É
         * —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ.
         * @param {string} label ‚Äî —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ –±–∞–≥–∞–∂–Ω–∏–∫–µ
         */

        // –§–£–ù–ö–¶–ò–ò –ê–†–ï–ù–î–´ –ò –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø
        const processRental = async () => {
    const rentBtnElement = document.getElementById('rent-btn');
    rentBtnElement.disabled = true;
    rentBtnElement.textContent = '–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑...';

    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
        rentBtnElement.disabled = false;
        rentBtnElement.textContent = '–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å';
        return;
    }

    try {
        // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É Netlify —Ñ—É–Ω–∫—Ü–∏—é –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º—É –ø—É—Ç–∏
        const response = await fetch('/.netlify/functions/create-payment', {
            method: 'POST',
            body: JSON.stringify({
                userId: userId,
                bikeId: '00001', 
                tariffId: 1
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        if (data.confirmation_url) {
            window.location.href = data.confirmation_url;
        } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.');
        }

    } catch (error) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –û—à–∏–±–∫–∞: ' + error.message);
        rentBtnElement.disabled = false;
        rentBtnElement.textContent = '–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å';
    }
};
        const processBooking = () => {
            availableBikesCount.textContent = '99';
            changeBikeImage('bike00001.png');
            progressBarFill.style.width = '100%';
            progressBarFill.style.backgroundColor = '#f5a623';
            progressStartLabel.textContent = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω';
            progressEndLabel.textContent = '–û—Å—Ç–∞–ª—Å—è 1 —á–∞—Å';
            addTransactionToHistory({ type: '–ë—Ä–æ–Ω—å', detail: '–ù–∞ 1 —á–∞—Å', amount: 0, icon: 'book' });
            qrModal.classList.add('hidden');
            showToast(bookingSuccessToast);
        };

        // === –õ–û–ì–ò–ö–ê –î–õ–Ø –¢–ê–†–ò–§–û–í PRIZMATIC ===
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã (–≤ –¥–Ω—è—Ö)
        const tariffData = {
            bronze: { title: '–ë—Ä–æ–Ω–∑–∞', cost: 1000, days: 3, deposit: 0 },
            silver: { title: '–°–µ—Ä–µ–±—Ä–æ', cost: 2000, days: 5, deposit: 0 },
            gold: { title: '–ó–æ–ª–æ—Ç–æ', cost: 3750, days: 7, deposit: 0 }
        };
        // –ï—Å–ª–∏ –º–µ–Ω—é –∑–∞–≥—Ä—É–∑–∏–ª–æ —Ç–∞—Ä–∏—Ñ—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API, –æ–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è.
        try {
            const tMapStr = sessionStorage.getItem('tariffMap');
            if (tMapStr) {
                const tMap = JSON.parse(tMapStr);
                Object.keys(tMap).forEach(key => {
                    const entry = tMap[key];
                    if (entry) {
                        // Preserve existing title if available
                        const existing = tariffData[key] || {};
                        tariffData[key] = {
                            title: existing.title || key,
                            cost: entry.cost,
                            days: entry.days,
                            id: entry.id,
                            deposit: entry.deposit || existing.deposit || 0,
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ
                            extensions: entry.extensions || existing.extensions || null
                        };
                    }
                });
            }
        } catch (err) {
            console.warn('Failed to parse tariffMap', err);
        }
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞—Ä–µ–Ω–¥—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É PRIZMATIC
        const processTariffRental = async (tariffKey, selectedExt = null) => {
            const tariff = tariffData[tariffKey];
            if (!tariff || !tariff.id) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ.');
                return;
            }

            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const rentBtn = document.getElementById('tariff-detail-select-btn');
            if(rentBtn) toggleButtonLoading(rentBtn, true, '–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ', '–û–±—Ä–∞–±–æ—Ç–∫–∞...');

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
                const { data: client, error: clientError } = await supabase
                    .from('clients')
                    .select('balance_rub')
                    .eq('id', userId)
                    .single();

                if (clientError) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞');

                const cost = selectedExt ? selectedExt.cost : tariff.cost;
                const hasEnoughBalance = client.balance_rub >= cost;

                if (hasEnoughBalance) {
                    // –°–ø–∏—Å—ã–≤–∞–µ–º —Å –±–∞–ª–∞–Ω—Å–∞
                    const response = await fetch('/api/payments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'charge-from-balance', userId: userId, tariffId: tariff.id })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å –±–∞–ª–∞–Ω—Å–∞');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    showToast(rentSuccessToast);
                    loadUserData();
                } else {
                    // –ë–∞–ª–∞–Ω—Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π
                    const response = await fetch('/api/payments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'create-payment', userId: userId, tariffId: tariff.id })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');

                    if (data.confirmation_url) {
                        window.location.href = data.confirmation_url;
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.');
                    }
                }

            } catch (err) {
                alert(`–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã: ${err.message}`);
            } finally {
                if(rentBtn) toggleButtonLoading(rentBtn, false, '–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ', '–û–±—Ä–∞–±–æ—Ç–∫–∞...');
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('tariff-detail-modal').classList.add('hidden');
                document.getElementById('tariff-modal').classList.add('hidden');
            }
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏ –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
        const tariffDetailModal = document.getElementById('tariff-detail-modal');
        const tariffDetailTitle = document.getElementById('tariff-detail-title');
        const tariffDetailPrice = document.getElementById('tariff-detail-price');
        const tariffDetailDuration = document.getElementById('tariff-detail-duration');
        const tariffDetailDeposit = document.getElementById('tariff-detail-deposit');
        const tariffDetailBackBtn = document.getElementById('tariff-detail-back-btn');
        const tariffDetailSelectBtn = document.getElementById('tariff-detail-select-btn');
        const tariffDetailCloseBtn = document.getElementById('tariff-detail-close-btn');
        // –°–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏/—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
        const tariffDetailExtList = document.getElementById('tariff-detail-extensions-list');
        // –¢–µ–∫—É—â–∏–π –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–∏–∑ –±–∞–∑—ã –∏–ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        let currentDetailExtensions = null;
        let pendingTariffKey = null;

        // === –≠–ª–µ–º–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã ===
        const extendContainer = document.getElementById('extend-container');
        const extendRentalBtn = document.getElementById('extend-rental-btn');
        const extendModal = document.getElementById('extend-modal');
        const extendOptionsList = document.getElementById('extend-options');
        const extendSelectBtn = document.getElementById('extend-select-btn');
        const extendCancelBtn = document.getElementById('extend-cancel-btn');
        const extendCloseBtn = document.getElementById('extend-close-btn');

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –∞—Ä–µ–Ω–¥—É –∏–∑ localStorage
         * @returns {object|null}
         */
        function loadActiveRental() {
            try {
                return JSON.parse(localStorage.getItem('activeRental')) || null;
            } catch (e) {
                return null;
            }
        }
        function showTariffDetail(tariffKey) {
    const t = tariffData[tariffKey];
    if (!t) {
        console.error(`–¢–∞—Ä–∏—Ñ —Å –∫–ª—é—á–æ–º "${tariffKey}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
        return;
    }

    pendingTariffKey = tariffKey;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    document.getElementById('tariff-detail-title').textContent = t.title || tariffKey;
    document.getElementById('tariff-detail-description').textContent = t.short_description || t.description || '';

    const optionsContainer = document.getElementById('tariff-options-list');
    optionsContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ —É –Ω–∞—Å –µ—Å—Ç—å
    const extensions = (t.extensions && Array.isArray(t.extensions) && t.extensions.length > 0)
        ? t.extensions
        : [{ days: t.duration_days, cost: t.price_rub }];

    currentDetailExtensions = extensions; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏

    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    extensions.forEach((ext, idx) => {
        const isChecked = (idx === 0) ? 'checked' : '';
        const isSelectedClass = (idx === 0) ? ' selected' : '';

        const optionHTML = `
            <label class="tariff-option-item${isSelectedClass}">
                <input type="radio" name="tariff-duration-option" value="${idx}" ${isChecked}>
                <div class="option-details">
                    <span class="option-duration">${ext.days} –¥–Ω–µ–π</span>
                </div>
                <span class="option-price">${ext.cost} ‚ÇΩ</span>
            </label>
        `;
        optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    optionsContainer.querySelectorAll('.tariff-option-item').forEach(label => {
        label.addEventListener('click', () => {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
            optionsContainer.querySelectorAll('.tariff-option-item').forEach(el => el.classList.remove('selected'));
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–∫–Ω—É—Ç—ã–π
            label.classList.add('selected');
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º checked –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π radio
            label.querySelector('input[type="radio"]').checked = true;
        });
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    tariffModal.classList.add('hidden');
    tariffDetailModal.classList.remove('hidden');
}
        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –∞—Ä–µ–Ω–¥—É –≤ localStorage
         * @param {object} obj
         */
        function saveActiveRental(obj) {
            try {
                localStorage.setItem('activeRental', JSON.stringify(obj));
            } catch (e) {}
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
         */
        function updateExtendButton() {
            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏.
            // –≠—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç –æ—à–∏–±–æ–∫ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∏,
            // –∫–æ–≥–¥–∞ extendContainer –±—ã–ª –æ–±—ä—è–≤–ª–µ–Ω –Ω–∏–∂–µ –∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è –≤ TDZ (temporal dead zone).
            const extendContainerEl = document.getElementById('extend-container');
            const active = loadActiveRental();
            if (extendContainerEl) {
                if (active && active.status === 'active') {
                    extendContainerEl.classList.remove('hidden');
                } else {
                    extendContainerEl.classList.add('hidden');
                }
            }
        }

        /**
         * –°—Ç—Ä–æ–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª–∫–µ
         * @param {Array} exts
         */
        function buildExtendOptions(exts) {
            if (!extendOptionsList) return;
            extendOptionsList.innerHTML = '';
            if (!exts || exts.length === 0) {
                const li = document.createElement('li');
                li.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥–ª–µ–Ω–∏–π.';
                extendOptionsList.appendChild(li);
                return;
            }
            exts.forEach((ext, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `<label><input type="radio" name="extend-option" value="${idx}" ${idx === 0 ? 'checked' : ''}> ${ext.days} –¥–Ω–µ–π ‚Äî ${ext.cost} ‚ÇΩ</label>`;
                extendOptionsList.appendChild(li);
            });
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã: —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ä–æ–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
         * @param {{days:number, cost:number}} ext
         */
        /**
         * Processes the rental extension by updating the database and UI.
         * @param {{days: number, cost: number}} ext - The selected extension option.
         */
        async function processExtension(ext) {
            if (!ext || !currentRentalForExtension) return;

            toggleButtonLoading(extendSelectBtn, true, '–ü—Ä–æ–¥–ª–∏—Ç—å', '–û–±—Ä–∞–±–æ—Ç–∫–∞...');

            try {
                const userId = localStorage.getItem('userId');
                const newEndDate = new Date(currentRentalForExtension.current_period_ends_at);
                newEndDate.setDate(newEndDate.getDate() + ext.days);

                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
                const { data: client, error: clientError } = await supabase
                    .from('clients')
                    .select('balance_rub')
                    .eq('id', userId)
                    .single();

                if (clientError) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞');

                const hasEnoughBalance = client.balance_rub >= ext.cost;

                if (hasEnoughBalance) {
                    // –°–ø–∏—Å—ã–≤–∞–µ–º —Å –±–∞–ª–∞–Ω—Å–∞
                    const { error: balanceError } = await supabase.rpc('add_to_balance', {
                        client_id_to_update: userId,
                        amount_to_add: -ext.cost
                    });
                    if (balanceError) throw new Error(`–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ${balanceError.message}`);

                    // 2. Update rental
                    const { error: rentalError } = await supabase
                        .from('rentals')
                        .update({
                            current_period_ends_at: newEndDate.toISOString(),
                            total_paid_rub: (currentRentalForExtension.total_paid_rub || 0) + ext.cost
                        })
                        .eq('id', currentRentalForExtension.id);
                    if (rentalError) throw new Error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã: ${rentalError.message}`);

                    // 3. Log payment
                    await supabase.from('payments').insert({
                        client_id: userId,
                        rental_id: currentRentalForExtension.id,
                        amount_rub: ext.cost,
                        status: 'succeeded',
                        payment_type: 'renewal',
                        payment_method_title: '–°–ø–∏—Å–∞–Ω–æ —Å –±–∞–ª–∞–Ω—Å–∞',
                        description: '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã'
                    });

                    // 4. Update UI
                    showToast(rentSuccessToast);
                    await loadUserData();
                } else {
                    // –ë–∞–ª–∞–Ω—Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π
                    const response = await fetch('/api/payments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'create-payment', userId: userId, amount: ext.cost, type: 'renewal', rentalId: currentRentalForExtension.id, days: ext.days })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');

                    if (data.confirmation_url) {
                        window.location.href = data.confirmation_url;
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.');
                    }
                }

            } catch (err) {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É: ${err.message}`);
            } finally {
                extendModal.classList.add('hidden');
                toggleButtonLoading(extendSelectBtn, false, '–ü—Ä–æ–¥–ª–∏—Ç—å', '–û–±—Ä–∞–±–æ—Ç–∫–∞...');
            }
        }

        // Event listener for the final extend button in the modal
        if (extendSelectBtn) {
            extendSelectBtn.addEventListener('click', () => {
                const selected = extendOptionsList.querySelector('input[name="extend-option"]:checked');
                if (!selected || !currentRentalForExtension) return;

                const idx = parseInt(selected.value, 10);
                const t = currentRentalForExtension.tariffs;
                let ext = null;

                if (t && t.extensions && t.extensions.length > 0) {
                    ext = t.extensions[idx];
                } else if (t) {
                    // Fallback for tariffs without explicit extensions
                    ext = { days: t.duration_days, cost: t.price_rub };
                }

                if (ext) {
                    processExtension(ext);
                }
            });
        }

        // Event listeners for cancel and close buttons in extend modal
        if (extendCancelBtn) {
            extendCancelBtn.addEventListener('click', () => {
                extendModal.classList.add('hidden');
            });
        }
        if (extendCloseBtn) {
            extendCloseBtn.addEventListener('click', () => {
                extendModal.classList.add('hidden');
            });
        }

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
        
        if (tariffDetailBackBtn) {
            tariffDetailBackBtn.addEventListener('click', () => {
                tariffDetailModal.classList.add('hidden');
                tariffModal.classList.remove('hidden');
                pendingTariffKey = null;
            });
        }
        if (tariffDetailCloseBtn) {
            tariffDetailCloseBtn.addEventListener('click', () => {
                tariffDetailModal.classList.add('hidden');
                pendingTariffKey = null;
            });
        }
        if (document.getElementById('select-tariff-btn')) {
            document.getElementById('select-tariff-btn').addEventListener('click', () => {
                if (!pendingTariffKey) return;

                // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                const selectedRadio = document.querySelector('input[name="tariff-duration-option"]:checked');
                if (!selectedRadio) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –∞—Ä–µ–Ω–¥—ã.');
                    return;
                }

                const selectedIndex = parseInt(selectedRadio.value, 10);
                const selectedExtension = currentDetailExtensions[selectedIndex];

                if (!selectedExtension) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    return;
                }

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∞—Ä–µ–Ω–¥—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                tariffDetailModal.classList.add('hidden');
                processTariffRental(pendingTariffKey, selectedExtension);
                pendingTariffKey = null;
            });
        }
        if (tariffDetailCloseBtn) {
            tariffDetailCloseBtn.addEventListener('click', () => {
                tariffDetailModal.classList.add('hidden');
                pendingTariffKey = null;
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
        tariffModalCloseBtn.addEventListener('click', () => {
            tariffModal.classList.add('hidden');
        });
        tariffModal.addEventListener('click', (e) => {
            if (e.target === tariffModal) tariffModal.classList.add('hidden');
        });

        // ========== –ü–û–î–î–ï–†–ñ–ö–ê –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ô –ó–ê–ì–†–£–ó–ö–ò –¢–ê–†–ò–§–û–í PRIZMATIC ==========
        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏–∑ API (–∏–ª–∏ localStorage, –µ—Å–ª–∏ —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞).
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø–∏—Å–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç map –≤ sessionStorage,
         * —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –º–æ–≥–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ü–µ–Ω–∞,
         * –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–µ–ø–æ–∑–∏—Ç, extensions).
         */
        async function loadPRIZMATICTariffs() {
            let data;
            try {
                const { data: supabaseData, error } = await supabase
                    .from('tariffs')
                    .select('*')
                    .eq('is_active', true)
                    .order('id', { ascending: true });

                if (error) throw error;
                
                data = supabaseData;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã
                localStorage.setItem('tariffs', JSON.stringify(data));
            } catch (err) {
                console.warn('Failed to fetch tariffs from Supabase, falling back to localStorage.', err);
                try {
                    data = JSON.parse(localStorage.getItem('tariffs') || '[]');
                } catch (e) {
                    data = [];
                }
            }
            
            // Data is already filtered by the query
            const activeTariffs = data || [];
            const list = document.querySelector('#tariff-modal .bike-list');
            if (list) {
                list.innerHTML = '';
                activeTariffs.forEach((t) => {
                    const key = t.slug || (t.title ? t.title.toLowerCase().replace(/\s+/g, '-') : '');
                    const item = document.createElement('div');
                    item.className = 'bike-list-item tariff-option';
                    item.dataset.tariff = key;
                    item.dataset.tariffId = t.id;
                    item.innerHTML = `<strong>${t.title}</strong><span>${t.price_rub} ‚ÇΩ / ${t.duration_days} –¥–Ω–µ–π</span><p style="font-size: 0.9rem; color: var(--text-secondary); margin: 4px 0 0 0;">${t.short_description || ''}</p>`;
                    // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —É–±–∏—Ä–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ
                    item.addEventListener('click', () => {
                        showTariffDetail(key);
                    });
                    list.appendChild(item);
                });
            }
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –¥–∞–Ω–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ processTariffRental
            const tariffMap = {};
            (data || []).forEach((t) => {
                let extensions = null;
                if (t.extensions) {
                    try {
                        extensions = typeof t.extensions === 'string' ? JSON.parse(t.extensions) : t.extensions;
                    } catch (e) {
                        extensions = null;
                    }
                }
                const key = t.slug || (t.title ? t.title.toLowerCase().replace(/\s+/g, '-') : '');
                tariffMap[key] = {
                    id: t.id,
                    cost: t.price_rub,
                    days: t.duration_days,
                    deposit: t.deposit_rub || 0,
                    title: t.title,
                    extensions: extensions,
                    short_description: t.short_description || '',
                    description: t.description || ''
                };
            });
            try {
                sessionStorage.setItem('tariffMap', JSON.stringify(tariffMap));
            } catch (e) {
                console.warn('Failed to store tariffMap', e);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç tariffData, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã
            try {
                Object.keys(tariffMap).forEach(key => {
                    const entry = tariffMap[key];
                    if (!entry) return;
                    const existing = tariffData[key] || {};
                    tariffData[key] = {
                        title: existing.title || entry.title || key,
                        cost: entry.cost,
                        days: entry.days,
                        deposit: entry.deposit || existing.deposit || 0,
                        id: entry.id,
                        extensions: entry.extensions || existing.extensions || null,
                        description: entry.description || existing.description || '',
                        short_description: entry.short_description || existing.short_description || ''
                    };
                });
            } catch (err) {
                console.warn('Failed to update tariffData', err);
            }

        }

        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
        scanBtn.addEventListener('click', () => {
            // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –æ–∫–Ω–æ
            const provider = localStorage.getItem('paymentProvider') || 'qr';
            if (provider === 'PRIZMATIC') {
                // –ü–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –æ–∫–Ω–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
                loadPRIZMATICTariffs().then(() => {
                    tariffModal.classList.remove('hidden');
                });
            } else {
                rentBtn.textContent = '–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å';
                rentBtn.dataset.action = 'rent';
                qrModal.classList.remove('hidden');
            }
        });
        if (scanIconBtn) scanIconBtn.addEventListener('click', () => scanBtn.click());

        if (idInputBtn) idInputBtn.addEventListener('click', () => idInputModal.classList.remove('hidden'));
        if (extendRowBtn) {
            extendRowBtn.addEventListener('click', () => {
                // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ —É –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
                const active = (function(){ try { return JSON.parse(localStorage.getItem('activeRental')) || null; } catch(e){ return null } })();
                if (!active) {
                    alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∞—Ä–µ–Ω–¥—ã –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.');
                    return;
                }
                const t = tariffData[active.tariffKey];
                if (!t) return;
                let exts;
                if (t.extensions && Array.isArray(t.extensions) && t.extensions.length > 0) {
                    exts = t.extensions;
                } else {
                    const fallbackDays = [7, 14, 30];
                    exts = fallbackDays.map(d => ({ days: d, cost: Math.round((t.cost || 0) * (d / (t.days || 7))) }));
                }
                buildExtendOptions(exts);
                extendModal.classList.remove('hidden');
            });
        }
        confirmIdBtn.addEventListener('click', () => {
            const enteredId = bikeIdInput.value.trim();
            // –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥ #00001, –Ω–æ –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥—Ä—É–≥–∏–µ ID
            if (enteredId === '00001') {
                idInputModal.classList.add('hidden');
                scanBtn.click();
            } else {
                alert('–í–µ–ª–æ—Å–∏–ø–µ–¥ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.');
            }
        });
        bookingBtn.addEventListener('click', () => bookingListModal.classList.remove('hidden'));
        bikeList.addEventListener('click', (e) => {
            const bikeItem = e.target.closest('.bike-list-item');
            if (bikeItem) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π ID
                const selectedId = bikeItem.dataset.bikeId;
                bookingListModal.classList.add('hidden');
                rentBtn.textContent = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —á–∞—Å';
                rentBtn.dataset.action = 'book';
                const qrTitleEl = qrModal.querySelector('h2');
                if (qrTitleEl) { qrTitleEl.innerHTML = `–í—ã –±—Ä–æ–Ω–∏—Ä—É–µ—Ç–µ<br>–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ #${selectedId || '00001'}`; }
                qrModal.classList.remove('hidden');
            }
        });
        rentBtn.addEventListener('click', () => {
            if (rentBtn.dataset.action === 'book') {
                processBooking();
            } else {
                processRental();
            }
        });

        [qrModalCloseBtn, idInputModalCloseBtn, bookingListModalCloseBtn, topupModalCloseBtn].forEach(btn => {
            btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden'));
        });
        [qrModal, idInputModal, bookingListModal, topupModal].forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        });

        balanceCard.addEventListener('click', () => topupModal.classList.remove('hidden'));
        payBtn.addEventListener('click', async () => {
    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.');
        return;
    }

    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
        return;
    }
    
    payBtn.disabled = true;
    payBtn.textContent = '–°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç...';

    try {
        const response = await fetch('/api/payments', {
            method: 'POST',
            body: JSON.stringify({
                action: 'create-payment',
                userId: userId,
                amount: amount // –ü–µ—Ä–µ–¥–∞–µ–º —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

        if (data.confirmation_url) {
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç—ã –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
            window.location.href = data.confirmation_url;
        } else if (data.status === 'pending' || data.status === 'succeeded') {
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –µ—Å—Ç—å –∏ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ
            topupModal.classList.add('hidden');
            alert('–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã. –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
            // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–ø—Ä–æ—Å–∏–≤ –µ–≥–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
        } else {
            throw new Error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞.');
        }

    } catch(error) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
    } finally {
        payBtn.disabled = false;
        payBtn.textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å';
    }
});



        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∏–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å—Å—è
        document.addEventListener('click', (e) => {
            const scan = e.target.closest('#scan-qr-btn');
            const balance = e.target.closest('#balance-card');
            const idbtn = e.target.closest('#id-input-btn');
            const extend = e.target.closest('#extend-row-btn');
            const booking = e.target.closest('#booking-btn');

            if (scan) {
                e.preventDefault();
                // –í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
                loadPRIZMATICTariffs().then(() => {
                    const modal = document.getElementById('tariff-modal');
                    if (modal) modal.classList.remove('hidden');
                });
                return;
            }

            if (balance) {
                e.preventDefault();
                const modal = document.getElementById('topup-modal');
                if (modal) modal.classList.remove('hidden');
                return;
            }

            if (idbtn) {
                e.preventDefault();
                const modal = document.getElementById('id-input-modal');
                if (modal) modal.classList.remove('hidden');
                return;
            }

            if (extend) {
                e.preventDefault();
                let active = null;
                try { active = JSON.parse(localStorage.getItem('activeRental')) || null; } catch(_) {}
                if (!active) { alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∞—Ä–µ–Ω–¥—ã –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.'); return; }
                const t = (typeof tariffData !== 'undefined' ? tariffData : (window.tariffData || {}))[active.tariffKey];
                if (!t) { alert('–ù–µ –Ω–∞–π–¥–µ–Ω –±–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.'); return; }
                let exts;
                if (t.extensions && Array.isArray(t.extensions) && t.extensions.length > 0) {
                    exts = t.extensions;
                } else {
                    const baseDays = t.days || 7;
                    const baseCost = t.cost || 0;
                    const fallbackDays = [7, 14, 30];
                    exts = fallbackDays.map(d => ({ days: d, cost: Math.round(baseCost * (d / baseDays)) }));
                }
                const list = document.getElementById('extend-options');
                if (list) {
                    list.innerHTML = '';
                    exts.forEach((ext, idx) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<label><input type="radio" name="extend-option" value="${idx}" ${idx===0?'checked':''}> ${ext.days} –¥–Ω–µ–π - ${ext.cost} ‚ÇΩ</label>`;
                        list.appendChild(li);
                    });
                }
                const modal = document.getElementById('extend-modal');
                if (modal) modal.classList.remove('hidden');
            }

            if (booking) {
                e.preventDefault();
                const modal = document.getElementById('booking-list-modal');
                if (modal) modal.classList.remove('hidden');
            }
        });
});
</script>
    <!-- –û–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –º–µ–Ω—é PRIZMATIC, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ -->
    <script src="menu.js" defer></script>

    <!-- Geolocation Tracking Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) return; // Only track logged-in users

            function startTracking() {
                if (!navigator.geolocation) {
                    console.log('Geolocation is not supported by your browser');
                    return;
                }

                function success(position) {
                    const latitude  = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    console.log(`Sending location: ${latitude}, ${longitude}`);

                    fetch('/api/user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'update-location', userId, latitude, longitude })
                    }).catch(err => console.error('Failed to send location:', err));
                }

                function error() {
                    console.log('Unable to retrieve your location');
                }

                // Initial position send
                navigator.geolocation.getCurrentPosition(success, error);

                // Send posiasdsadtion every 30 seconds
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(success, error);
                }, 30000);
            }

            // Ask for permission and start tracking
            navigator.permissions.query({name:'geolocation'}).then(function(result) {
                if (result.state === 'granted') {
                    startTracking();
                } else if (result.state === 'prompt') {
                    // We can ask the user with a button click, but for now, we'll just start
                    // which will trigger the browser's native prompt.
                    startTracking();
                }
                // If state is 'denied', we can't do anything.13213231
            });
        });
    </script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API Telegram –¥–æ—Å—Ç—É–ø–µ–Ω
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç —à–∞–ø–∫–∏
            tg.setHeaderColor('#ffffff');
        }
    });
</script>
    
</body>
</html>

