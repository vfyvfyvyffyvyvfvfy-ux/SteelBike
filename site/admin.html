<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1280">
  <!-- Hardcoded CONFIG for reliability -->
  <script>
    window.CONFIG = {
      SUPABASE_URL: 'https://qjrycnazrzetnciyqakm.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqcnljbmF6cnpldG5jaXlxYWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2ODcyMTYsImV4cCI6MjA3NTI2MzIxNn0.5SLKsfOjnSk-rehECpH1FPgCflCl1mi511VBTsDUXdU',
      SUPABASE_SERVICE_ROLE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqcnljbmF6cnpldG5jaXlxYWttIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTY4NzIxNiwiZXhwIjoyMDc1MjYzMjE2fQ.2d9EIff6My4Muv5qzjtbeV3RXpwAlHTNh3icxF-cIU8',
      GOOGLE_API_KEY: 'AIzaSyCds0FmujbSW88GPJwXeyhIjD8JOdyx5uU',
      GEMINI_API_KEY: 'AIzaSyCds0FmujbSW88GPJwXeyhIjD8JOdyx5uU',
      TELEGRAM_BOT_TOKEN: '8161502944:AAG7jnhO963k4w0RXAy808qL9IMVn3sASGQ',
      YOOKASSA_SHOP_ID: '1165363',
      YOOKASSA_SECRET_KEY: 'live_HOBpl4TqCwl-BBo2JP7hDCUpCIKJbY4pddBAHO4R-eU',
      BOT_NOTIFY_URL: 'https://steelbikedogovor.onrender.com/notify',
      OCR_WORKER_URL: 'https://832a1274ed7e.ngrok-free.app',
      ADMIN_SECRET_KEY: 'your_super_secret_admin_key',
      INTERNAL_SECRET: 'MySuperSecretKeyForBikeAppOCR123!',
      CONTRACTS_API_URL: 'https://steelbikedogovor.onrender.com'
    };
    const CONFIG = window.CONFIG;
  </script>
  <title>Админ‑панель | Bike App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=7.4">
  <link rel="stylesheet" href="blend.css">
  <link rel="stylesheet" href="admin.css">
  <style>
    /* Map container styles */
    #admin-map-container {
      width: 100%;
      height: 650px;
      /* Fixed pixel height for Yandex Maps compatibility */
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    /* Агрессивно прячем все стандартные элементы управления Яндекс.Карт */
    [class*="copyrights-pane"],
    [class*="search__control"],
    [class*="gotoymaps"],
    .ymaps-2-1-79-controls__control_toolbar,
    .ymaps-2-1-79-map-copyrights-promo,
    .ymaps-2-1-79-copyright {
      display: none !important;
    }

    /* Search results dropdown */
    .search-results-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
    }

    .search-result-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--progress-bar-bg);
      transition: background-color 0.2s;
    }

    .search-result-item:hover,
    .search-result-item.active {
      background-color: var(--primary-color-light, #f0f8ff);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@tiptap/starter-kit@2.0.0-beta.183/dist/index.global.js"></script>
  <!-- Yandex Maps API -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=a32fae3e-06f9-4231-87a0-f225b5d7a04a"></script>
  <script src="transitions.js" defer></script>
</head>

<body>
  <div id="admin-app">
    <!-- Глобальные модальные окна (вынесены из секций для правильного позиционирования) -->


    <!-- Авторизация -->
    <div id="login-section">
      <h2>Вход в админ‑панель</h2>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Пароль" required>
        <button type="submit">Войти</button>
      </form>
    </div>

    <!-- Основной интерфейс -->
    <div id="dashboard-section" class="hidden">

      <!-- Assignments -->
      <nav id="admin-nav">
        <button type="button" data-section="dashboard-main" class="active">Dashboard</button>
        <button type="button" data-section="assignments">Заявки</button>
        <button type="button" data-section="bookings">Брони</button>
        <button type="button" data-section="tariffs">Тарифы</button>
        <button type="button" data-section="clients">Клиенты</button>
        <button type="button" data-section="rentals">Аренды</button>
        <button type="button" data-section="payments">Платежи</button>
        <button type="button" data-section="bikes">Велосипеды</button>
        <button type="button" data-section="batteries">Аккумуляторы</button>
        <button type="button" data-section="templates" class="hidden">Шаблоны</button>
        <button type="button" data-section="admin-map">Карта</button>
        <a href="admin_support.html" class="admin-nav-link-button">
          <button type="button">Поддержка</button>
        </a>
      </nav>

      <!-- Sections Container for Smooth Transitions -->
      <div class="admin-sections-container">
        <!-- Dashboard -->
        <section id="dashboard-main-section" class="admin-section">
          <div class="section-header">
            <h2>Панель мониторинга</h2>
            <div class="dashboard-header-info">
              <div class="dashboard-time" id="dashboard-time">Загрузка...</div>
              <div class="dashboard-location" id="dashboard-location">Москва</div>
            </div>
          </div>

          <!-- Dashboard Grid Layout -->
          <div class="dashboard-grid">
            <!-- Left Column: Main Stats -->
            <div class="dashboard-column">
              <div class="dashboard-section-title">Велосипеды</div>
              <div class="dashboard-stats-group" id="dashboard-bikes">
                <!-- Bike stats will be loaded here -->
              </div>

              <div class="dashboard-section-title" style="margin-top: 24px;">Операции</div>
              <div class="dashboard-stats-group" id="dashboard-operations">
                <!-- Operations stats will be loaded here -->
              </div>
            </div>

            <!-- Right Column: Revenue & Chart -->
            <div class="dashboard-column-wide">
              <div class="dashboard-revenue-card" id="dashboard-revenue">
                <div class="revenue-header">
                  <div class="revenue-title">Доход за неделю</div>
                  <div class="revenue-amount" id="weekly-income">Загрузка...</div>
                </div>
                <div class="revenue-stats" id="revenue-breakdown">
                  <!-- Revenue breakdown will be loaded here -->
                </div>
              </div>

              <div class="dashboard-chart-card">
                <div class="chart-header">Доход по дням</div>
                <div class="chart-container" style="height: 280px;">
                  <canvas id="payments-chart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Assignments -->
        <section id="assignments-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Заявки на аренду</h2>
            <div class="section-toolbar">
              <input type="search" id="assignment-search" class="toolbar-input"
                placeholder="Поиск по клиенту или тарифу">
            </div>
          </div>
          <table id="assignments-table" class="admin-table">
            <thead>
              <tr>
                <th>Клиент</th>
                <th>Тариф</th>
                <th>Тип</th>
                <th>Дата заявки</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Bookings -->
        <section id="bookings-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Активные бронирования</h2>
            <button type="button" id="setup-booking-cost-btn" class="btn btn-secondary">Настроить стоимость</button>
          </div>
          <table id="bookings-table" class="admin-table table-wide-actions">
            <thead>
              <tr>
                <th>Клиент</th>
                <th>Телефон</th>
                <th>Бронь истекает</th>
                <th>Прогресс</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              <!-- Сюда будут загружаться данные -->
            </tbody>
          </table>
        </section>

        <!-- Тарифы -->
        <section id="tariffs-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Тарифы</h2>
            <div class="section-toolbar">
              <button type="button" id="tariff-add-btn" class="btn btn-primary">Добавить тариф</button>
            </div>
          </div>

          <table id="tariffs-table" class="admin-table">
            <thead>
              <tr>
                <th>Название</th>
                <th>Краткое описание</th>
                <th>Продления (дн./₽)</th>
                <th>Активен</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Шаблоны договоров -->
        <section id="templates-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Шаблоны договоров</h2>
            <div class="section-toolbar">
              <button type="button" id="template-new-btn" class="btn btn-secondary">Новый шаблон</button>
              <button type="button" id="template-preview-btn" class="btn">Предпросмотр</button>
              <button type="button" id="template-save-btn" class="btn btn-primary">Сохранить</button>
            </div>
          </div>
          <div class="templates-wrapper">
            <div class="templates-list">
              <table id="templates-table" class="admin-table">
                <thead>
                  <tr>
                    <th>Название</th>
                    <th>Активен</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="template-editor-panel">
              <div class="template-form">
                <input type="hidden" id="template-id">
                <label>Название</label>
                <input type="text" id="template-name" placeholder="Например: Договор аренды (RU)">
                <label class="checkbox-label" style="margin-top:10px"><input type="checkbox" id="template-active"
                    checked> Активен</label>
              </div>

              <div class="placeholder-palette">
                <div class="palette-group">
                  <strong>Клиент</strong>
                  <div class="chips" id="chips-client"></div>
                </div>
                <div class="palette-group">
                  <strong>Тариф</strong>
                  <div class="chips" id="chips-tariff"></div>
                </div>
                <div class="palette-group">
                  <strong>Аренда</strong>
                  <div class="chips" id="chips-rental"></div>
                </div>
                <div class="palette-group">
                  <strong>Служебные</strong>
                  <div class="chips" id="chips-aux"></div>
                </div>
              </div>

              <div class="editor-toolbar">
                <button type="button" data-cmd="bold"><b>B</b></button>
                <button type="button" data-cmd="italic"><i>I</i></button>
                <button type="button" data-cmd="underline"><u>U</u></button>
                <button type="button" data-cmd="insertParagraph">¶</button>
              </div>
              <div id="template-editor" class="template-editor"></div>
              <p class="hint">Подсказка: кликайте на чипсы, чтобы вставить плейсхолдер (например
                <code>{{client.full_name}}</code>) в позицию курсора.
              </p>
            </div>
          </div>
        </section>

        <!-- Клиенты -->
        <section id="clients-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Клиенты</h2>
            <div class="section-toolbar">
              <input type="search" id="client-search" class="toolbar-input"
                placeholder="Поиск по имени, телефону или городу">
              <button id="export-clients-btn" class="btn btn-secondary">Экспорт CSV</button>
            </div>
          </div>

          <table id="clients-table" class="admin-table">
            <thead>
              <tr>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Теги</th>
                <th>Создан</th>
                <th>Просмотр</th>
                <th>Вер.</th>
                <th>Дейст.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Аренды -->
        <section id="rentals-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Аренды</h2>
          </div>
          <table id="rentals-table" class="admin-table table-wide-actions">
            <thead>
              <tr>
                <th>Клиент</th>
                <th>Телефон</th>
                <th>Велосипед</th>
                <th>Начало</th>
                <th>Конец</th>
                <th>Сумма</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Платежи -->
        <section id="payments-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Платежи</h2>
            <div class="section-toolbar">
              <input type="search" id="payment-search" class="toolbar-input"
                placeholder="Поиск по клиенту, сумме или описанию">
            </div>
          </div>
          <table id="payments-table" class="admin-table">
            <thead>
              <tr>
                <th>Клиент</th>
                <th>Сумма</th>
                <th>Тип платежа</th>
                <th>Способ оплаты</th>
                <th>Статус</th>
                <th>Дата</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Велосипеды -->
        <section id="bikes-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Велосипеды</h2>
            <div class="section-toolbar">
              <input type="search" id="bike-search" class="toolbar-input"
                placeholder="Поиск по коду, модели или городу">
              <button type="button" id="bike-add-btn" class="btn btn-primary">Добавить велосипед</button>
            </div>
          </div>

          <table id="bikes-table" class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Код</th>
                <th>Модель</th>
                <th>Город</th>
                <th>Статус</th>
                <th>Ремонт</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Карта велосипедов -->
        <section id="admin-map-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Карта велосипедов</h2>
            <div class="section-toolbar">
              <input type="text" id="courier-search-input" class="form-control" placeholder="Найти курьера по имени..."
                style="width: 250px;" autocomplete="off">
              <div id="courier-search-results" class="search-results-dropdown" style="display: none;"></div>
            </div>
          </div>
          <div id="admin-map-container"></div>
        </section>

        <!-- НОВАЯ СЕКЦИЯ: Аккумуляторы -->
        <section id="batteries-section" class="admin-section hidden">
          <div class="section-header">
            <h2>Аккумуляторы</h2>
            <div class="section-toolbar">
              <input type="search" id="battery-search" class="toolbar-input" placeholder="Поиск по номеру или описанию">
              <button type="button" id="battery-add-btn" class="btn btn-primary">Добавить аккумулятор</button>
            </div>
          </div>

          <table id="batteries-table" class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Серийный номер</th>
                <th>Мощность (Wh)</th>
                <th>Описание</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>


      </div> <!-- End admin-sections-container -->
    </div>
  </div>

  <script>
    // Удобство: прокрутка к форме добавления тарифа
    document.addEventListener('DOMContentLoaded', () => {
      const addBtn = document.getElementById('tariff-add-btn');
      const formTitle = document.getElementById('tariff-form-title');
      if (addBtn && formTitle) {
        addBtn.addEventListener('click', () => {
          formTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }

      // Поиск и сортировка в таблице клиентов (UI)
      const search = document.getElementById('client-search');
      const clientsTable = document.getElementById('clients-table');
      const tbody = clientsTable ? clientsTable.querySelector('tbody') : null;
      if (search && tbody) {
        search.addEventListener('input', () => {
          const q = search.value.toLowerCase();
          tbody.querySelectorAll('tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
          });
        });
      }

      // Поиск в таблице заявок (assignments)
      const assignmentSearch = document.getElementById('assignment-search');
      const assignmentsTable = document.getElementById('assignments-table');
      const assignmentsTbody = assignmentsTable ? assignmentsTable.querySelector('tbody') : null;
      if (assignmentSearch && assignmentsTbody) {
        assignmentSearch.addEventListener('input', () => {
          const q = assignmentSearch.value.toLowerCase();
          assignmentsTbody.querySelectorAll('tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
          });
        });
      }

      // Поиск в таблице платежей (payments)
      const paymentSearch = document.getElementById('payment-search');
      const paymentsTable = document.getElementById('payments-table');
      const paymentsTbody = paymentsTable ? paymentsTable.querySelector('tbody') : null;
      if (paymentSearch && paymentsTbody) {
        paymentSearch.addEventListener('input', () => {
          const q = paymentSearch.value.toLowerCase();
          paymentsTbody.querySelectorAll('tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
          });
        });
      }

      // Поиск в таблице велосипедов (bikes)
      const bikeSearch = document.getElementById('bike-search');
      const bikesTable = document.getElementById('bikes-table');
      const bikesTbody = bikesTable ? bikesTable.querySelector('tbody') : null;
      if (bikeSearch && bikesTbody) {
        bikeSearch.addEventListener('input', () => {
          const q = bikeSearch.value.toLowerCase();
          bikesTbody.querySelectorAll('tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
          });
        });
      }
      if (clientsTable && tbody) {
        let dir = 1; // 1 asc, -1 desc
        clientsTable.querySelector('thead')?.addEventListener('click', (e) => {
          const th = e.target.closest('th');
          if (!th) return;
          const idx = Array.from(th.parentElement.children).indexOf(th);
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.sort((a, b) => {
            const ta = a.children[idx]?.textContent?.trim() || '';
            const tb = b.children[idx]?.textContent?.trim() || '';
            const na = parseFloat(ta.replace(/[^0-9.]/g, ''));
            const nb = parseFloat(tb.replace(/[^0-9.]/g, ''));
            let cmp = (!isNaN(na) && !isNaN(nb) && /^\d/.test(ta)) ? (na - nb) : ta.localeCompare(tb, 'ru');
            return cmp * dir;
          });
          dir *= -1;
          tbody.innerHTML = '';
          rows.forEach(r => tbody.appendChild(r));
        });
      }
    });
  </script>
  <script src="admin.js" defer></script>
  <!-- Глобальные модальные окна (вынесены из секций для правильного позиционирования) -->
  <!-- Модальное окно для редактирования аренды -->
  <div id="rental-edit-modal" class="overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Редактирование аренды</h3>
        <button id="rental-edit-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="rental-edit-form">
          <input type="hidden" id="rental-edit-id">

          <div class="form-group">
            <label for="rental-edit-bike">Велосипед</label>
            <select id="rental-edit-bike" class="form-control"></select>
          </div>

          <div class="form-group">
            <label for="rental-edit-batteries">Аккумуляторы</label>
            <div id="rental-edit-batteries-list"
              style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
              <!-- Список выбранных АКБ будет здесь -->
            </div>
            <button type="button" id="rental-edit-change-batteries-btn" class="btn btn-secondary"
              style="width: 100%;">Изменить АКБ</button>
          </div>

          <div class="form-group">
            <label for="rental-edit-end-date">Дата окончания</label>
            <input type="datetime-local" id="rental-edit-end-date" class="form-control">
          </div>

          <div class="form-group">
            <label for="rental-edit-status">Статус</label>
            <select id="rental-edit-status" class="form-control">
              <option value="awaiting_contract_signing">Ожидает подписания</option>
              <option value="active">Активна</option>
              <option value="completed">Завершена</option>
              <option value="completed_by_admin">Завершено админом</option>
              <option value="rejected">Отклонена</option>
            </select>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="rental-edit-save-btn" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- New Modal for Return Processing (Step-by-Step) -->
  <div id="return-process-modal" class="overlay hidden">
    <div class="modal" style="max-width: 650px;">
      <div class="modal-header">
        <h3 id="return-modal-title">Приемка велосипеда</h3>
        <button id="return-process-close-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="return-process-rental-id">

        <!-- Индикатор шагов -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; position: relative;">
          <div style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: #e0e0e0; z-index: 0;">
          </div>
          <div class="step-indicator" data-step="1">
            <div class="step-circle active">1</div>
            <div class="step-label">Статус велосипеда</div>
          </div>
          <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Недостатки</div>
          </div>
          <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Счет за ущерб</div>
          </div>
        </div>

        <!-- Шаг 1: Выбор статуса велосипеда -->
        <div id="return-step-1" class="return-step">
          <h4 style="margin-bottom: 15px;">Куда отправить велосипед?</h4>
          <div class="form-group">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="radio-card">
                <input type="radio" name="bike-next-status" value="available" checked>
                <div class="radio-card-content">
                  <strong>В свободные</strong>
                  <span>Велосипед в хорошем состоянии, готов к аренде</span>
                </div>
              </label>
              <label class="radio-card">
                <input type="radio" name="bike-next-status" value="in_service">
                <div class="radio-card-content">
                  <strong>В ремонт</strong>
                  <span>Требуется обслуживание или ремонт</span>
                </div>
              </label>
            </div>
          </div>
          <div class="form-group hidden" id="service-reason-group" style="margin-top: 15px;">
            <label for="service-reason">Причина ремонта</label>
            <input type="text" id="service-reason" class="form-control" placeholder="Пример: Замена тормозных колодок">
          </div>
        </div>

        <!-- Шаг 2: Недостатки -->
        <div id="return-step-2" class="return-step hidden">
          <h4 style="margin-bottom: 15px;">Выявленные недостатки</h4>
          <div class="form-group">
            <label for="return-defects">Укажите все обнаруженные недостатки (каждый с новой строки)</label>
            <textarea id="return-defects" class="form-control" rows="6" placeholder="Пример:
Царапина на раме (левая сторона)
Сломан звонок
Потертость на седле"></textarea>
            <small style="color: #666; margin-top: 5px; display: block;">Эти данные будут добавлены в акт
              приема-передачи</small>
          </div>
        </div>

        <!-- Шаг 3: Счет за ущерб -->
        <div id="return-step-3" class="return-step hidden">
          <h4 style="margin-bottom: 15px;">Выставить счет за ущерб?</h4>
          <div class="form-group">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="radio-card">
                <input type="radio" name="charge-damage" value="no" checked>
                <div class="radio-card-content">
                  <strong>Нет</strong>
                  <span>Завершить приемку без выставления счета</span>
                </div>
              </label>
              <label class="radio-card">
                <input type="radio" name="charge-damage" value="yes">
                <div class="radio-card-content">
                  <strong>Да, выставить счет</strong>
                  <span>Списать сумму за повреждения</span>
                </div>
              </label>
            </div>
          </div>
          <div class="form-group hidden" id="damage-amount-group" style="margin-top: 15px;">
            <label for="damage-amount">Сумма к списанию (₽)</label>
            <input type="number" id="damage-amount" class="form-control" placeholder="Например: 5000" min="0"
              step="100">
            <label for="damage-description" style="margin-top: 10px;">Описание</label>
            <input type="text" id="damage-description" class="form-control"
              placeholder="Например: Ремонт поврежденной рамы">
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" id="return-prev-btn" class="btn btn-secondary hidden">← Назад</button>
        <button type="button" id="return-next-btn" class="btn btn-primary">Далее →</button>
        <button type="button" id="finalize-return-btn" class="btn btn-primary hidden">Завершить приемку</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления/редактирования тарифа (Step-by-Step) -->
  <div id="tariff-modal" class="overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="tariff-modal-title">Новый тариф</h3>
        <button id="tariff-modal-close-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tariff-id">

        <!-- Индикатор шагов -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; position: relative;">
          <div
            style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--progress-bar-bg); z-index: 0;">
          </div>
          <div class="step-indicator" data-step="1">
            <div class="step-circle active">1</div>
            <div class="step-label">Основная информация</div>
          </div>
          <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Стоимость</div>
          </div>
          <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Настройки</div>
          </div>
        </div>

        <!-- Шаг 1: Основная информация -->
        <div id="tariff-step-1" class="tariff-step">
          <h4 style="margin-bottom: 15px;">Основная информация</h4>
          <div class="form-group">
            <label for="tariff-title">Название тарифа</label>
            <input type="text" id="tariff-title" class="form-control" placeholder="Например: Электроскутеры U2"
              required>
          </div>
          <div class="form-group">
            <label for="tariff-short-description">Краткое описание</label>
            <textarea id="tariff-short-description" class="form-control" rows="3" placeholder="Краткое описание для карточки тарифа
Например: Идеально для долгих поездок по городу"></textarea>
            <small style="color: #666; margin-top: 5px; display: block;">Это описание будет показано в карточке
              тарифа</small>
          </div>
        </div>

        <!-- Шаг 2: Стоимость и длительность -->
        <div id="tariff-step-2" class="tariff-step hidden">
          <h4 style="margin-bottom: 15px;">Стоимость и длительность</h4>
          <p style="color: #666; margin-bottom: 15px;">Первая строка - основной период аренды</p>
          <div id="extensions-list" class="extensions-list"></div>
          <button type="button" id="add-extension-btn" class="btn btn-secondary" style="margin-top: 10px;">+ Добавить
            продление</button>
        </div>

        <!-- Шаг 3: Настройки -->
        <div id="tariff-step-3" class="tariff-step hidden">
          <h4 style="margin-bottom: 15px;">Активность тарифа</h4>
          <div class="form-group"
            style="padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--progress-bar-bg);">
            <label class="checkbox-label"
              style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
              <input type="checkbox" id="tariff-active" checked style="width: 20px; height: 20px; cursor: pointer;">
              <div>
                <div style="font-weight: 600; color: var(--dark-green); margin-bottom: 4px;">Тариф активен</div>
                <div style="font-size: 13px; color: #666;">Только активные тарифы видны клиентам в приложении</div>
              </div>
            </label>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" id="tariff-prev-btn" class="btn btn-secondary hidden">← Назад</button>
        <button type="button" id="tariff-next-btn" class="btn btn-primary">Далее →</button>
        <button type="button" id="tariff-save-btn" class="btn btn-primary hidden">Сохранить тариф</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления/редактирования велосипеда (Step-by-Step) -->
  <div id="bike-modal" class="overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="bike-modal-title">Новый велосипед</h3>
        <button id="bike-modal-close-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="bike-id">

        <!-- Индикатор шагов -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; position: relative;">
          <div
            style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--progress-bar-bg); z-index: 0;">
          </div>
          <div class="step-indicator" data-step="1">
            <div class="step-circle active">1</div>
            <div class="step-label">Основная информация</div>
          </div>
          <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Технические данные</div>
          </div>
          <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Статус и оборудование</div>
          </div>
        </div>

        <!-- Шаг 1: Основная информация -->
        <div id="bike-step-1" class="bike-step">
          <h4 style="margin-bottom: 20px;">Основная информация</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-code">Код велосипеда</label>
            <input type="text" id="bike-code" class="form-control" placeholder="Например: 00004" required>
            <small style="color: #666; margin-top: 5px; display: block;">Уникальный идентификатор велосипеда</small>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-model">Модель</label>
            <input type="text" id="bike-model" class="form-control" placeholder="Например: Trek FX 2" required>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-city">Город</label>
            <select id="bike-city" class="form-control" required>
              <option value="Москва">Москва</option>
              <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-tariff-select">Тариф</label>
            <select id="bike-tariff-select" class="form-control">
              <option value="">— Не выбран —</option>
            </select>
            <small style="color: #666; margin-top: 5px; display: block;">Тариф можно изменить позже</small>
          </div>
        </div>

        <!-- Шаг 2: Технические данные -->
        <div id="bike-step-2" class="bike-step hidden">
          <h4 style="margin-bottom: 20px;">Технические данные</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-frame-number">Номер рамы</label>
            <input type="text" id="bike-frame-number" class="form-control" placeholder="Например: FR123456">
          </div>

          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-registration-number">Регистрационный номер</label>
            <input type="text" id="bike-registration-number" class="form-control" placeholder="Например: А123БВ77">
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-iot-device-id">Номер IOT-трекера</label>
            <input type="text" id="bike-iot-device-id" class="form-control" placeholder="Например: IOT987654">
          </div>
        </div>

        <!-- Шаг 3: Статус и оборудование -->
        <div id="bike-step-3" class="bike-step hidden">
          <h4 style="margin-bottom: 20px;">Статус и дополнительное оборудование</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-status">Статус велосипеда</label>
            <select id="bike-status" class="form-control" required>
              <option value="available">Свободен</option>
              <option value="rented">В аренде</option>
              <option value="reserved">Зарезервирован</option>
              <option value="in_service">На обслуживании</option>
              <option value="maintenance">Обслуживание</option>
              <option value="out_of_order">Неисправен</option>
              <option value="unavailable">Недоступен</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="bike-additional-equipment">Дополнительное оборудование</label>
            <textarea id="bike-additional-equipment" class="form-control" rows="4"
              placeholder="Например: Замок, держатель для бутылки, корзина"></textarea>
            <small style="color: #666; margin-top: 5px; display: block;">Укажите всё дополнительное оборудование</small>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" id="bike-prev-btn" class="btn btn-secondary hidden">← Назад</button>
        <button type="button" id="bike-next-btn" class="btn btn-primary">Далее →</button>
        <button type="button" id="bike-save-btn" class="btn btn-primary hidden">Сохранить велосипед</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления/редактирования аккумулятора (Step-by-Step) -->
  <div id="battery-modal" class="overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="battery-modal-title">Новый аккумулятор</h3>
        <button id="battery-modal-close-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="battery-id">

        <!-- Индикатор шагов -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; position: relative;">
          <div
            style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--progress-bar-bg); z-index: 0;">
          </div>
          <div class="step-indicator" data-step="1">
            <div class="step-circle active">1</div>
            <div class="step-label">Основная информация</div>
          </div>
          <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Технические данные</div>
          </div>
          <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Статус</div>
          </div>
        </div>

        <!-- Шаг 1: Основная информация -->
        <div id="battery-step-1" class="battery-step">
          <h4 style="margin-bottom: 20px;">Основная информация</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="battery-serial-number">Серийный номер</label>
            <input type="text" id="battery-serial-number" class="form-control" placeholder="Например: АКБ-001" required>
            <small style="color: #666; margin-top: 5px; display: block;">Уникальный идентификатор аккумулятора</small>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="battery-description">Описание</label>
            <textarea id="battery-description" class="form-control" rows="3"
              placeholder="Любые заметки об аккумуляторе"></textarea>
          </div>
        </div>

        <!-- Шаг 2: Технические данные -->
        <div id="battery-step-2" class="battery-step hidden">
          <h4 style="margin-bottom: 20px;">Технические характеристики</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="battery-capacity">Мощность (Ватт-часы)</label>
            <input type="number" id="battery-capacity" class="form-control" placeholder="Например: 1000" min="0"
              step="10">
            <small style="color: #666; margin-top: 5px; display: block;">Емкость аккумулятора в Wh</small>
          </div>
        </div>

        <!-- Шаг 3: Статус -->
        <div id="battery-step-3" class="battery-step hidden">
          <h4 style="margin-bottom: 20px;">Статус аккумулятора</h4>
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="battery-status">Текущий статус</label>
            <select id="battery-status" class="form-control" required>
              <option value="available">Свободен</option>
              <option value="in_use">В аренде</option>
              <option value="charging">На зарядке</option>
              <option value="maintenance">На обслуживании</option>
            </select>
            <small style="color: #666; margin-top: 5px; display: block;">Статус можно изменить позже</small>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" id="battery-prev-btn" class="btn btn-secondary hidden">← Назад</button>
        <button type="button" id="battery-next-btn" class="btn btn-primary">Далее →</button>
        <button type="button" id="battery-save-btn" class="btn btn-primary hidden">Сохранить аккумулятор</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для выбора велосипеда -->
  <div id="assign-bike-modal" class="overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Привязать велосипед к аренде</h3>
        <button id="assign-bike-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="assign-bike-form">
          <input type="hidden" id="assign-rental-id">
          <div class="form-group">
            <label for="bike-select">Выберите свободный велосипед:</label>
            <select id="bike-select" class="form-control" required></select>
          </div>
          <div id="bike-details" style="display: none;">
            <h4>Данные велосипеда</h4>
            <div class="form-group">
              <label for="assign-bike-frame-number">Номер рамы</label>
              <input type="text" id="assign-bike-frame-number" class="modal-form-input">
            </div>
            <div class="form-group">
              <label for="assign-bike-battery-numbers">Номера аккумуляторов (через запятую)</label>
              <input type="text" id="assign-bike-battery-numbers" class="modal-form-input">
            </div>
            <div class="form-group">
              <label for="assign-bike-registration-number">Регистрационный номер</label>
              <input type="text" id="assign-bike-registration-number" class="modal-form-input">
            </div>
            <div class="form-group">
              <label for="assign-bike-iot-device-id">Номер IOT-трекера</label>
              <input type="text" id="assign-bike-iot-device-id" class="modal-form-input">
            </div>
            <div class="form-group">
              <label for="assign-bike-additional-equipment">Дополнительное оборудование</label>
              <textarea id="assign-bike-additional-equipment" class="modal-form-input" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="assign-bike-submit-btn" class="btn btn-primary">Привязать и активировать</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно предпросмотра тарифа -->
  <div id="tariff-preview-modal" class="overlay hidden">
    <div class="modal-content" style="max-width: 400px;">
      <button class="modal-close" id="tariff-preview-close-btn">&times;</button>
      <h2>Предпросмотр тарифа</h2>
      <div id="tariff-preview-content" class="tariff-preview-card">
        <!-- Здесь будет карточка -->
      </div>
    </div>
  </div>

  <!-- Предпросмотр шаблона -->
  <div id="template-preview-overlay" class="overlay hidden">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Предпросмотр договора</h3>
        <button id="template-preview-close" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div id="template-preview-content" class="preview-content"></div>
      </div>
    </div>
  </div>

  <!-- Редактирование распознанных данных -->
  <div id="client-edit-overlay" class="overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3>Редактирование данных клиента</h3>
        <button id="client-edit-cancel" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="client-edit-form"></form>
      </div>
      <div class="modal-footer">
        <button type="button" id="client-edit-save" class="btn-primary">Сохранить</button>
      </div>

      <!-- Toast Notifications Container -->
      <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <!-- Просмотр распознанных данных и фото -->
  <div id="client-info-overlay" class="overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3>Информация о клиенте</h3>
        <button id="client-info-close" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" id="client-info-content">
        <h4>Распознанные данные:</h4>
        <div id="recognized-data-container">
          <div id="recognized-display"></div>
          <form id="recognized-edit-form" class="hidden"></form>
        </div>

        <!-- Client Tags Section -->
        <h4 style="margin-top: 20px;">Теги</h4>
        <div id="client-tags-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <!-- Tags will be loaded here -->
        </div>

        <h4 style="margin-top: 20px;">Загруженные фото:</h4>
        <div id="photo-links" class="photo-grid"></div>

        <!-- NEW NOTES SECTION -->
        <h4 style="margin-top: 20px;">Заметки о клиенте</h4>
        <div id="client-notes-list"
          style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; background-color: var(--card-bg); border-radius: 12px; padding: 10px;">
          <!-- Notes will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="add-tag-footer-btn" class="btn btn-secondary">Добавить тег</button>
        <button type="button" id="add-note-footer-btn" class="btn btn-secondary">Добавить заметку</button>
        <button type="button" id="invoice-create-btn" class="btn btn-primary">Выставить счет</button>
        <button type="button" id="balance-adjust-btn" class="btn btn-secondary">Изменить баланс</button>
        <button type="button" id="client-info-edit-toggle" class="btn btn-secondary">Редактировать</button>
        <button type="button" id="client-info-save" class="btn btn-primary hidden">Сохранить</button>
        <button type="button" id="client-info-close-2" class="btn btn-secondary">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для выставления счета -->
  <div id="invoice-modal" class="overlay hidden">
    <div class="modal" style="max-width: 420px;">
      <div class="modal-header">
        <h3>Выставить счет</h3>
        <button id="invoice-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="invoice-form">
          <input type="hidden" id="invoice-client-id">
          <div class="form-group">
            <label for="invoice-amount">Сумма (₽)</label>
            <input type="number" id="invoice-amount" class="modal-form-input" placeholder="Например: 500" required>
          </div>
          <div class="form-group">
            <label for="invoice-description">Описание счета</label>
            <textarea id="invoice-description" class="modal-form-input" placeholder="Например: Штраф за повреждение"
              rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="invoice-submit-btn" class="btn btn-primary">Выставить и списать</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для корректировки баланса -->
  <div id="balance-modal" class="overlay hidden">
    <div class="modal" style="max-width: 420px;">
      <div class="modal-header">
        <h3>Корректировка баланса</h3>
        <button id="balance-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="balance-form">
          <input type="hidden" id="balance-client-id">
          <div class="form-group">
            <label for="balance-amount">Сумма (₽)</label>
            <p class="form-hint" style="font-size: 0.8rem; color: #6b6b6b; margin-top: -5px;">Используйте отрицательное
              число для списания.</p>
            <input type="number" id="balance-amount" class="modal-form-input" placeholder="Например: 500 или -100"
              required>
          </div>
          <div class="form-group">
            <label for="balance-reason">Причина корректировки</label>
            <input type="text" id="balance-reason" class="modal-form-input" placeholder="Например: Бонус за лояльность"
              required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="balance-submit-btn" class="btn btn-primary">Применить</button>
      </div>
    </div>
  </div>

  <!-- Просмотр фото (увеличение) -->
  <div id="image-viewer-overlay" class="overlay hidden">
    <div class="image-viewer">
      <button id="image-viewer-close" class="close-btn">&times;</button>
      <button id="image-viewer-prev" class="arrow prev" aria-label="Предыдущее">&#10094;</button>
      <button id="image-viewer-next" class="arrow next" aria-label="Следующее">&#10095;</button>
      <img id="image-viewer-img" alt="Фото" />
    </div>
  </div>

  <!-- Модальное окно для возврата -->
  <div id="refund-modal" class="overlay hidden">
    <div class="modal" style="max-width: 420px;">
      <div class="modal-header">
        <h3>Оформить возврат</h3>
        <button id="refund-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="refund-form">
          <input type="hidden" id="refund-payment-id">
          <div class="form-group">
            <label for="refund-amount">Сумма возврата (₽)</label>
            <input type="number" id="refund-amount" class="modal-form-input" placeholder="Например: 100.50" required>
          </div>
          <div class="form-group">
            <label for="refund-reason">Причина возврата (необязательно)</label>
            <input type="text" id="refund-reason" class="modal-form-input"
              placeholder="Например: Некачественная услуга">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="refund-submit-btn" class="btn btn-primary">Выполнить возврат</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно деталей платежа -->
  <div id="payment-details-modal" class="overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Детали платежа</h3>
        <button id="payment-details-close-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div id="payment-details-content"></div>
      </div>
    </div>
  </div>

  <!-- НОВЫЙ БЛОК 1: Список тарифов (как у клиента) -->
  <div id="client-view-tariff-list-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close" id="client-view-tariff-list-close-btn">&times;</button>
      <h2>Тарифы (вид клиента)</h2>
      <div class="bike-list" id="client-view-tariff-list-container">
        <!-- Сюда будут грузиться тарифы -->
      </div>
    </div>
  </div>

  <!-- НОВЫЙ БЛОК 2: Детали тарифа (как у клиента) -->
  <div id="client-view-tariff-detail-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close" id="client-view-tariff-detail-close-btn">&times;</button>
      <h2 id="client-view-tariff-detail-title"></h2>
      <p id="client-view-tariff-detail-description" class="tariff-description"></p>
      <div class="tariff-options-list" id="client-view-tariff-options-list">
        <!-- Сюда будут грузиться варианты -->
      </div>
      <!-- Кнопка неактивна, т.к. это предпросмотр -->
      <button class="btn btn-primary" disabled>Выбрать тариф</button>
    </div>
  </div>

  <!-- Modal for adding tag -->
  <div id="add-tag-modal" class="overlay hidden">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Добавить тег</h3>
        <button id="add-tag-modal-close" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="add-tag-form">
          <div class="form-group">
            <label for="new-tag-input">Тег</label>
            <input type="text" id="new-tag-input" class="modal-form-input" placeholder="Введите тег" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="add-tag-modal-submit" class="btn btn-primary">Добавить</button>
      </div>
    </div>
  </div>

  <!-- Modal for adding note -->
  <div id="add-note-modal" class="overlay hidden">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Добавить заметку</h3>
        <button id="add-note-modal-close" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="add-note-form">
          <div class="form-group">
            <label for="new-note-input">Заметка</label>
            <textarea id="new-note-input" class="modal-form-input" placeholder="Введите заметку" rows="3"
              required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="add-note-modal-submit" class="btn btn-primary">Добавить</button>
      </div>
    </div>
  </div>

  <!-- НОВОЕ МОДАЛЬНОЕ ОКНО: Выбор аккумуляторов для аренды -->
  <div id="assign-batteries-modal" class="overlay hidden">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Выберите аккумуляторы для аренды</h3>
        <button id="assign-batteries-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="assign-batteries-form">
          <input type="hidden" id="assign-batteries-rental-id">
          <p>Выберите один или несколько свободных аккумуляторов:</p>
          <!-- ВОТ СЮДА ВСТАВЬ ПОИСК -->
          <div class="form-group" style="margin-bottom: 15px;">
            <input type="search" id="battery-search-in-modal" class="form-control"
              placeholder="Поиск по серийному номеру...">
          </div>
          <div id="battery-select-list"
            style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 10px;">
            <!-- Список АКБ будет загружен сюда через JS -->
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="assign-batteries-submit-btn" class="btn btn-primary">Подтвердить и
          активировать</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Модальное окно настройки стоимости бронирования -->
  <div id="booking-cost-modal" class="overlay hidden">
    <div class="modal" style="max-width: 420px;">
      <div class="modal-header">
        <h3>Стоимость бронирования</h3>
        <button id="booking-cost-cancel-btn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="booking-cost-form">
          <div class="form-group">
            <label for="booking-cost-input">Цена за 2 часа брони (₽)</label>
            <input type="number" id="booking-cost-input" class="modal-form-input" placeholder="Например: 100" required>
            <p class="form-hint" style="font-size: 0.8rem; color: #6b6b6b; margin-top: 5px;">Эта сумма будет списана с
              клиента и зачислена на его внутренний баланс. Если установить 0, бронирование будет бесплатным.</p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="booking-cost-save-btn" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>


</body>

</html>