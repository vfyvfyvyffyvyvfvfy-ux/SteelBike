# Конституция проекта SteelBike

## Введение

Этот документ является "конституцией" проекта SteelBike - полным описанием архитектуры, принципов, структуры и правил разработки системы аренды электровелосипедов. Документ служит единым источником истины для всех разработчиков и заинтересованных сторон.

## 1. Обзор проекта

### 1.1 Назначение
SteelBike - это веб-приложение и Telegram-бот для аренды электровелосипедов в городах России (Москва, Санкт-Петербург).

### 1.2 Ключевые возможности
- Регистрация пользователей через Telegram Web App
- Автоматическое распознавание документов (OCR) с помощью Google Gemini AI
- Бронирование и аренда электровелосипедов
- Интеграция с платежной системой ЮKassa
- Административная панель для управления арендой
- Система поддержки клиентов
- Генерация договоров аренды
- Отслеживание велосипедов на карте

### 1.3 Целевая аудитория
- **Клиенты**: граждане РФ и иностранные граждане (с патентом) 18+ лет
- **Администраторы**: операторы, управляющие парком велосипедов
- **Инвесторы**: партнеры, отслеживающие статистику

## 2. Технологический стек

### 2.1 Frontend
- **HTML5/CSS3/JavaScript** (Vanilla JS, без фреймворков)
- **Telegram Web App API** - интеграция с Telegram
- **Yandex Maps API** - отображение карты и велосипедов
- **Supabase JS Client** - работа с базой данных
- **Service Worker** - PWA функциональность

### 2.2 Backend
- **Vercel Serverless Functions** (Node.js) - основной API
- **Render.com** - OCR Worker и контрактный сервис
- **Python (aiogram)** - Telegram бот
- **Supabase (PostgreSQL + PostGIS)** - база данных
- **Supabase Storage** - хранение файлов

### 2.3 Внешние сервисы
- **Google Gemini AI** - распознавание документов (OCR)
- **ЮKassa** - платежная система
- **Telegram Bot API** - уведомления и регистрация
- **Yandex Maps** - геолокация

### 2.4 Инфраструктура
- **Hosting**: Vercel (frontend + API)
- **Database**: Supabase (PostgreSQL)
- **Workers**: Render.com
- **Bot**: Render.com или VPS
- **CDN**: Vercel Edge Network

## 3. Архитектура системы

### 3.1 Микросервисная архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    КЛИЕНТЫ                               │
│  Telegram Web App  │  Telegram Bot  │  Web Browser      │
└──────────────┬──────────────┬────────────┬──────────────┘
               │              │            │
               ▼              ▼            ▼
┌──────────────────────────────────────────────────────────┐
│              VERCEL SERVERLESS API                        │
│  /api/auth  │  /api/user  │  /api/payments  │  /api/admin│
└──────────────┬──────────────┬────────────┬───────────────┘
               │              │            │
               ▼              ▼            ▼
┌──────────────────────────────────────────────────────────┐
│                   SUPABASE                                │
│  PostgreSQL + PostGIS  │  Storage  │  Auth               │
└──────────────┬──────────────┬────────────────────────────┘
               │              │
               ▼              ▼
┌──────────────────────────────────────────────────────────┐
│              ВНЕШНИЕ СЕРВИСЫ                              │
│  OCR Worker (Render)  │  Contract Service (Render)       │
│  Telegram Bot (Render)│  ЮKassa  │  Gemini AI           │
└──────────────────────────────────────────────────────────┘
```

### 3.2 Компоненты системы

#### 3.2.1 Frontend (Telegram Web App)
**Расположение**: `/site/`

**Основные страницы**:
- `index.html` - главная страница (авторизация/регистрация)
- `map.html` - карта с велосипедами
- `profile.html` - профиль пользователя
- `stats.html` - статистика аренды
- `admin.html` - административная панель
- `admin_support.html` - панель поддержки

**Ключевые модули**:
- `api.js` - обертка для API запросов
- `main.js` - логика главной страницы
- `menu.js` - навигационное меню
- `ui.js` - UI компоненты
- `transitions.js` - анимации переходов
- `branding.js` - брендинг (логотипы, названия)
- `support-chat.js` - чат поддержки
- `stats.js` - статистика

#### 3.2.2 Backend API (Vercel Functions)
**Расположение**: `/api/`

**Endpoints**:
- `auth.js` - регистрация и авторизация
- `user.js` - операции пользователя (бронирование, аренда)
- `payments.js` - создание платежей
- `payment-webhook.js` - обработка webhook от ЮKassa
- `admin.js` - административные операции
- `storage.js` - работа с файлами
- `getTariffByBike.js` - получение тарифа по велосипеду
- `notify.js` - отправка уведомлений
- `config.js` - конфигурация (переменные окружения)

#### 3.2.3 OCR Worker (Render)
**Расположение**: `/ocr-worker/`

**Назначение**: Асинхронная обработка документов с помощью Google Gemini AI

**Функции**:
- Скачивание фото документов из Telegram
- Распознавание паспортов, патентов, водительских удостоверений
- Извлечение структурированных данных (ФИО, дата рождения, номер документа)
- Сохранение результатов в Supabase

#### 3.2.4 Telegram Bot (Python)
**Расположение**: `/bot.py`

**Функции**:
- Регистрация пользователей через бота
- Сбор документов (паспорт, патент, видео-селфи)
- Отправка уведомлений о статусе аренды
- Прием уведомлений от админки

#### 3.2.5 Contract Service (Render)
**Расположение**: `/SteelBike-server/`

**Функции**:
- Генерация PDF договоров аренды
- Генерация актов приема-передачи
- Загрузка документов в Supabase Storage

### 3.3 База данных (Supabase PostgreSQL)

**Основные таблицы**:

```sql
clients          -- Клиенты (пользователи)
bikes            -- Велосипеды
batteries        -- Батареи
tariffs          -- Тарифы аренды
rentals          -- Аренды
bookings         -- Бронирования
payments         -- Платежи
support_messages -- Сообщения поддержки
contract_templates -- Шаблоны договоров
app_settings     -- Настройки приложения
```

**Ключевые поля**:

**clients**:
- `id` (uuid) - уникальный идентификатор
- `telegram_user_id` (bigint) - ID в Telegram
- `phone` (text) - номер телефона
- `name` (text) - ФИО
- `verification_status` (text) - статус верификации
- `balance_rub` (numeric) - баланс
- `yookassa_payment_method_id` (text) - привязанная карта
- `autopay_enabled` (boolean) - автоплатеж
- `recognized_data` (jsonb) - данные из OCR

**bikes**:
- `id` (bigint) - номер велосипеда
- `status` (text) - статус (free, rented, repair, etc.)
- `location` (geometry) - координаты
- `battery_id` (bigint) - ID батареи
- `qr_code` (text) - QR код

**rentals**:
- `id` (uuid) - ID аренды
- `client_id` (uuid) - ID клиента
- `bike_id` (bigint) - ID велосипеда
- `tariff_id` (bigint) - ID тарифа
- `status` (text) - статус аренды
- `started_at` (timestamp) - начало
- `ends_at` (timestamp) - окончание
- `contract_url` (text) - ссылка на договор

## 4. Бизнес-процессы

### 4.1 Процесс регистрации

```
1. Пользователь открывает Telegram бота
2. Нажимает "Зарегистрироваться"
3. Принимает пользовательское соглашение
4. Делится контактом (телефон)
5. Вводит ФИО, дату рождения
6. Выбирает город (Москва/СПб)
7. Выбирает гражданство
8. Загружает фото паспорта (главный разворот + регистрация)
9. [Для иностранцев] Загружает патент
10. [Опционально] Загружает водительское удостоверение
11. Указывает телефон экстренного контакта
12. Записывает видео-селфи с документом
13. Система отправляет данные на OCR Worker
14. OCR Worker распознает документы
15. Администратор проверяет и одобряет/отклоняет
16. Пользователь получает уведомление о статусе
```

### 4.2 Процесс аренды

```
1. Пользователь открывает карту в приложении
2. Выбирает свободный велосипед
3. Нажимает "Забронировать"
4. Выбирает тариф (1 день, 7 дней, 30 дней)
5. Система создает бронирование (15 минут)
6. Пользователь подходит к велосипеду
7. Сканирует QR код или вводит номер
8. Система проверяет баланс/карту
9. Генерируется договор аренды (PDF)
10. Пользователь подписывает договор (электронная подпись)
11. Система списывает оплату
12. Аренда активируется
13. Велосипед переходит в статус "rented"
14. Пользователь получает доступ к велосипеду
```

### 4.3 Процесс возврата

```
1. Пользователь возвращает велосипед в точку
2. Администратор принимает велосипед
3. Проверяет состояние (шаг 1: статус - свободен/ремонт)
4. Указывает выявленные недостатки (шаг 2)
5. Решает о выставлении счета за ущерб (шаг 3)
6. Система генерирует акт приема-передачи
7. Списывает средства за ущерб (если есть)
8. Обновляет статус велосипеда
9. Отправляет уведомление клиенту
10. Клиент подписывает акт сдачи
11. Аренда завершается
```

### 4.4 Процесс продления

```
1. За 24 часа до окончания аренды система проверяет баланс
2. Если autopay_enabled = true:
   - Система пытается списать с баланса
   - Если недостаточно - списывает с карты
   - Продлевает аренду на выбранный период
3. Если autopay_enabled = false:
   - Отправляет уведомление о необходимости продления
   - Пользователь вручную продлевает через приложение
4. Если оплата не прошла:
   - Аренда переходит в статус "awaiting_return"
   - Отправляется уведомление о необходимости вернуть велосипед
```

## 5. Безопасность

### 5.1 Аутентификация
- **Telegram Web App**: проверка `initData` от Telegram
- **Web App**: JWT токены (auth_token в таблице clients)
- **Admin Panel**: секретный ключ (ADMIN_SECRET_KEY)
- **API**: проверка токенов в заголовках

### 5.2 Авторизация
- **Row Level Security (RLS)** в Supabase
- Клиенты видят только свои данные
- Администраторы имеют полный доступ через service_role_key

### 5.3 Защита данных
- **HTTPS** для всех соединений
- **Переменные окружения** для секретов
- **Хеширование** паролей (если используется)
- **Валидация** всех входных данных

### 5.4 Платежи
- **PCI DSS**: токенизация карт через ЮKassa
- **Webhook signature**: проверка подписи от ЮKassa
- **Idempotency**: защита от дублирования платежей

## 6. Конфигурация

### 6.1 Переменные окружения

**Vercel (Production)**:
```
SUPABASE_URL=https://avamqfmuhiwtlumjkzmv.supabase.co
SUPABASE_ANON_KEY=<anon_key>
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
TELEGRAM_BOT_TOKEN=<bot_token>
GOOGLE_API_KEY=<gemini_api_key>
YOOKASSA_SHOP_ID=<shop_id>
YOOKASSA_SECRET_KEY=<secret_key>
OCR_WORKER_URL=https://ocr-worker.onrender.com
BOT_NOTIFY_URL=https://bot.onrender.com/notify
CONTRACTS_API_URL=https://contracts.onrender.com
ADMIN_SECRET_KEY=<admin_secret>
INTERNAL_SECRET=<internal_secret>
```

**OCR Worker (Render)**:
```
SUPABASE_URL=<url>
SUPABASE_ANON_KEY=<anon_key>
TELEGRAM_BOT_TOKEN=<bot_token>
GEMINI_API_KEY=<gemini_key>
INTERNAL_SECRET=<internal_secret>
```

**Telegram Bot (Render/VPS)**:
```
TELEGRAM_BOT_TOKEN=<bot_token>
SUPABASE_URL=<url>
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
GOOGLE_API_KEY=<gemini_key>
ADMIN_SECRET_KEY=<admin_secret>
```

### 6.2 Конфигурационные файлы

- `.env` - локальные переменные (не коммитится)
- `.env.example` - шаблон переменных
- `site/config.js` - frontend конфигурация
- `site/config.example.js` - шаблон frontend конфигурации
- `vercel.json` - конфигурация Vercel
- `netlify.toml` - конфигурация Netlify (альтернатива)

## 7. Структура проекта

```
SteelBike/
├── .kiro/                    # Kiro IDE конфигурация
│   └── specs/                # Спецификации фич
├── api/                      # Vercel Serverless Functions
│   ├── admin.js              # Админ API
│   ├── auth.js               # Аутентификация
│   ├── user.js               # Пользовательские операции
│   ├── payments.js           # Платежи
│   ├── payment-webhook.js    # Webhook ЮKassa
│   ├── storage.js            # Работа с файлами
│   ├── notify.js             # Уведомления
│   ├── config.js             # Конфигурация
│   └── package.json          # Зависимости API
├── site/                     # Frontend (Telegram Web App)
│   ├── index.html            # Главная страница
│   ├── map.html              # Карта велосипедов
│   ├── profile.html          # Профиль
│   ├── admin.html            # Админ панель
│   ├── admin_support.html    # Поддержка
│   ├── stats.html            # Статистика
│   ├── api.js                # API клиент
│   ├── main.js               # Главная логика
│   ├── menu.js               # Меню
│   ├── ui.js                 # UI компоненты
│   ├── style.css             # Стили
│   ├── config.js             # Конфигурация
│   └── manifest.json         # PWA манифест
├── ocr-worker/               # OCR Worker (Render)
│   ├── server.js             # Express сервер
│   ├── package.json          # Зависимости
│   └── README.md             # Документация
├── SteelBike-server/         # Contract Service (Render)
│   ├── server.js             # Express сервер
│   └── package.json          # Зависимости
├── bot.py                    # Telegram Bot (Python)
├── ocr.py                    # OCR модуль
├── database_full_schema.sql  # Полная схема БД
├── database_migration.sql    # Миграции БД
├── vercel.json               # Конфигурация Vercel
├── package.json              # Зависимости проекта
├── .env.example              # Шаблон переменных
└── README-ARCHITECTURE.md    # Документация архитектуры
```

## 8. Принципы разработки

### 8.1 Код
- **Простота**: Vanilla JS, минимум зависимостей
- **Читаемость**: понятные имена переменных и функций
- **Модульность**: разделение на логические модули
- **DRY**: не повторяться (переиспользование кода)

### 8.2 API
- **RESTful**: использование HTTP методов по назначению
- **JSON**: все данные в формате JSON
- **Обработка ошибок**: всегда возвращать понятные ошибки
- **Валидация**: проверка всех входных данных

### 8.3 База данных
- **Нормализация**: избегать дублирования данных
- **Индексы**: на часто используемые поля
- **Транзакции**: для критичных операций
- **RLS**: защита данных на уровне БД

### 8.4 UI/UX
- **Telegram Design**: следование гайдлайнам Telegram
- **Адаптивность**: работа на всех устройствах
- **Быстрота**: минимальное время загрузки
- **Понятность**: интуитивный интерфейс

## 9. Deployment

### 9.1 Vercel (Frontend + API)
```bash
# Установка Vercel CLI
npm i -g vercel

# Деплой
vercel --prod

# Переменные окружения
vercel env add SUPABASE_URL
vercel env add SUPABASE_SERVICE_ROLE_KEY
# ... остальные переменные
```

### 9.2 Render (OCR Worker, Bot, Contracts)
1. Подключить GitHub репозиторий
2. Создать Web Service
3. Указать команду запуска: `node server.js` или `python bot.py`
4. Добавить переменные окружения
5. Деплой автоматически при push в main

### 9.3 Supabase
1. Создать проект на supabase.com
2. Применить схему: `database_full_schema.sql`
3. Применить миграции: `database_migration.sql`
4. Настроить Storage buckets: `passports`, `contracts`
5. Настроить RLS политики

## 10. Мониторинг и поддержка

### 10.1 Логирование
- **Vercel**: автоматические логи функций
- **Render**: логи в реальном времени
- **Supabase**: логи запросов к БД

### 10.2 Ошибки
- **Sentry** (опционально): отслеживание ошибок
- **Console logs**: для отладки
- **Error boundaries**: обработка ошибок в UI

### 10.3 Метрики
- **Vercel Analytics**: посещаемость
- **Supabase Dashboard**: использование БД
- **Custom metrics**: в таблице app_settings

## 11. Roadmap

### 11.1 Текущие возможности (v1.0)
- ✅ Регистрация через Telegram
- ✅ OCR документов
- ✅ Бронирование и аренда
- ✅ Платежи через ЮKassa
- ✅ Админ панель
- ✅ Поддержка клиентов
- ✅ Генерация договоров

### 11.2 Планируемые улучшения (v1.1)
- 🔄 Push-уведомления
- 🔄 Реферальная программа
- 🔄 Система скидок и промокодов
- 🔄 Интеграция с IoT (умные замки)
- 🔄 Мобильное приложение (iOS/Android)

### 11.3 Долгосрочные планы (v2.0)
- 📅 Расширение на другие города
- 📅 Франшиза
- 📅 API для партнеров
- 📅 Аналитика и ML для оптимизации

## 12. Контакты и поддержка

### 12.1 Команда
- **Разработка**: [Ваше имя]
- **Поддержка**: support@SteelBike.ru
- **Telegram**: @SteelBike_support

### 12.2 Ресурсы
- **GitHub**: [ссылка на репозиторий]
- **Документация**: [ссылка на docs]
- **Telegram канал**: [ссылка на канал]

---

**Версия документа**: 1.0  
**Дата последнего обновления**: 06.10.2025  
**Автор**: SteelBike Team
