# Requirements Document

## Introduction

В системе платежей существует путаница между двумя понятиями:
- **Метод оплаты** (payment_method) - способ оплаты: карта, СБП, баланс
- **Тип платежа** (payment_type) - назначение платежа: аренда, продление, пополнение и т.д.

Сейчас в коде эти понятия используются неправильно и непоследовательно. Необходимо привести всю систему к единому стандарту, где:
- `payment_type` - описывает **назначение** платежа (аренда, продление, пополнение)
- `payment_method` - описывает **способ** оплаты (карта, СБП, баланс)

## Requirements

### Requirement 1: Стандартизация полей в таблице payments

**User Story:** Как разработчик, я хочу иметь четкую структуру данных о платежах, чтобы избежать путаницы при работе с системой

#### Acceptance Criteria

1. WHEN платеж записывается в таблицу payments THEN система SHALL использовать поле `payment_type` для хранения типа операции (rental, renewal, top-up, booking, refund_to_balance, adjustment, balance_debit, invoice)
2. WHEN платеж записывается в таблицу payments THEN система SHALL использовать поле `payment_method` для хранения способа оплаты (card, sbp, balance)
3. WHEN платеж создается через карту THEN поле `payment_method` SHALL содержать значение 'card'
4. WHEN платеж создается через баланс THEN поле `payment_method` SHALL содержать значение 'balance'
5. WHEN платеж создается через СБП THEN поле `payment_method` SHALL содержать значение 'sbp'

### Requirement 2: Обновление API создания платежей

**User Story:** Как система, я хочу правильно записывать информацию о платежах при их создании, чтобы данные были корректными

#### Acceptance Criteria

1. WHEN создается платеж через `api/payments.js` (action: create-payment) THEN система SHALL определять `payment_method` как 'card' или 'sbp' в зависимости от выбранного способа оплаты
2. WHEN создается платеж через `api/payments.js` (action: charge-from-balance) THEN система SHALL устанавливать `payment_method` = 'balance'
3. WHEN записывается платеж в таблицу payments THEN система SHALL сохранять оба поля: `payment_type` и `payment_method`
4. WHEN платеж частично оплачивается балансом и картой THEN система SHALL создавать две записи: одну с payment_method='balance', другую с payment_method='card'

### Requirement 3: Обновление webhook обработки платежей

**User Story:** Как система, я хочу правильно обрабатывать успешные платежи от ЮKassa, чтобы корректно записывать информацию о способе оплаты

#### Acceptance Criteria

1. WHEN webhook получает уведомление о успешном платеже THEN система SHALL определять `payment_method` на основе данных от ЮKassa (payment.payment_method.type)
2. WHEN платеж был через карту THEN система SHALL записывать payment_method='card'
3. WHEN платеж был через СБП THEN система SHALL записывать payment_method='sbp'
4. WHEN создается запись о списании с баланса THEN система SHALL устанавливать payment_method='balance'
5. IF платеж содержит metadata.payment_type THEN система SHALL использовать это значение для поля payment_type

### Requirement 4: Обновление отображения в админ-панели

**User Story:** Как администратор, я хочу видеть корректную информацию о платежах в админ-панели, чтобы понимать какой способ оплаты использовался

#### Acceptance Criteria

1. WHEN администратор просматривает список платежей THEN система SHALL отображать колонку "Тип платежа" с описанием назначения (аренда, продление и т.д.)
2. WHEN администратор просматривает список платежей THEN система SHALL отображать колонку "Способ оплаты" с методом (карта, СБП, баланс)
3. WHEN администратор кликает на платеж THEN модальное окно SHALL показывать оба поля: тип платежа и способ оплаты
4. WHEN отображается способ оплаты THEN система SHALL использовать русские названия: "Карта", "СБП", "Баланс"

### Requirement 5: Обновление статистики платежей

**User Story:** Как пользователь, я хочу видеть корректную информацию о своих платежах в истории операций, чтобы понимать за что и как я платил

#### Acceptance Criteria

1. WHEN пользователь просматривает историю операций в `site/stats.js` THEN система SHALL отображать тип операции (пополнение, аренда, продление)
2. WHEN пользователь просматривает детали платежа THEN система SHALL показывать способ оплаты (карта, СБП, баланс)
3. WHEN отображается список операций THEN иконки SHALL соответствовать типу операции, а не способу оплаты

### Requirement 6: Миграция существующих данных

**User Story:** Как система, я хочу чтобы существующие записи о платежах были приведены к новому формату, чтобы обеспечить консистентность данных

#### Acceptance Criteria

1. WHEN выполняется миграция THEN система SHALL добавить поле `payment_method` в таблицу payments (если его нет)
2. WHEN выполняется миграция THEN для существующих записей с payment_type содержащим '_card_part' система SHALL установить payment_method='card'
3. WHEN выполняется миграция THEN для существующих записей с payment_type содержащим '_balance_part' система SHALL установить payment_method='balance'
4. WHEN выполняется миграция THEN для записей с payment_type='balance_debit' система SHALL установить payment_method='balance'
5. WHEN выполняется миграция THEN для остальных записей с yookassa_payment_id система SHALL установить payment_method='card' по умолчанию
